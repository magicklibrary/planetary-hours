<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Electional Hours</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: sans-serif; 
      background: black; 
      color: white; 
      margin: 0; 
      padding: 1rem; 
    }
    h2 { text-align: center; margin-bottom: 1rem; }
    #electional { display: flex; flex-direction: column; gap: 6px; max-height: 90vh; overflow-y: auto; }
    .hour-bar { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: 6px; transition: all 0.3s ease; }
    .hour-bar.active { border: 2px solid gold; background-color: rgba(255, 215, 0, 0.1); }
    .hour-info { display: flex; flex-direction: column; }
    .hour-info span { font-size: 0.9rem; opacity: 0.85; }
    .hour-symbol { font-weight: bold; font-size: 1.1rem; margin-right: 8px; }
    button {
      display: block;
      margin: 10px auto;
      padding: 10px 16px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: gold;
      color: black;
    }
  </style>
</head>
<body>

<h2>Electional Hour Overview</h2>
<button id="updateLocationBtn">Update Location</button>
<div id="electional">Loading...</div>

<script src="ephemeris.js"></script>
<script src="zodiac.js"></script>
<script src="planetary.js"></script>
<script src="dignity.js"></script>
<script src="storage.js"></script>

<script>
async function loadElectional() {
  const container = document.getElementById("electional");
  container.innerHTML = "Loading...";

  const location = loadLocation();
  if (!location) {
    container.innerText = "No location set. Click 'Update Location' above.";
    return;
  }

  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const dayRuler = DAY_RULERS[today.getDay()] || "Sun";

  let sunTimes;
  try {
    sunTimes = getSunTimes(today, location.lat, location.lon);
  } catch (err) {
    console.error("Error computing sun times:", err);
    container.innerText = "Error computing sunrise/sunset for your location.";
    return;
  }

  const hours = generatePlanetaryHours(dayRuler, sunTimes.sunrise, sunTimes.sunset);
  if (!hours || hours.length === 0) {
    container.innerText = "No planetary hours could be generated.";
    return;
  }

  container.innerHTML = "";

  // Load natal data
  let natal = null;
  const natalRaw = localStorage.getItem("birthData");
  if (natalRaw) {
    try { natal = JSON.parse(natalRaw); } catch (err) { console.warn("Invalid natal data", err); }
  }

  hours.forEach(h => {
    // Ensure dates
    if (!(h.start instanceof Date)) h.start = new Date(h.start);
    if (!(h.end instanceof Date)) h.end = new Date(h.end);

    const zodiac = getPlanetZodiac(h.planet.name, h.start);

    let natalMatch = false;
    if (natal && natal.date && natal.time) {
      const natalDate = new Date(`${natal.date}T${natal.time}`);
      const natalLongs = planetLongitudes(natalDate);
      const natalZodiac = getZodiacFromLongitude(natalLongs[h.planet.name]);
      natalMatch = natalZodiac.name === zodiac.name;
    }

    const dignity = getDignity(h.planet.name, zodiac.name);
    const strength = getHourStrength(h.planet.name, zodiac.name, natalMatch);

    // Visual alpha based on strength
    const alpha = Math.min(0.9, 0.1 + strength / 5);

    const div = document.createElement("div");
    div.className = "hour-bar" + (now >= h.start && now < h.end ? " active" : "");
    div.style.backgroundColor = `rgba(255,255,255,${alpha})`;
    div.style.borderColor = h.planet.color;

    div.innerHTML = `
      <div class="hour-symbol" style="color:${h.planet.color}">${h.planet.symbol}</div>
      <div class="hour-info">
        <span>${h.planet.name} | ${h.start.getHours().toString().padStart(2,'0')}:00 - ${h.end.getHours().toString().padStart(2,'0')}:00</span>
        <span>${zodiac.symbol} ${zodiac.name}</span>
        <span>Dignity: ${dignity}</span>
        <span>Strength: ${strength}${natalMatch ? " | Resonant with natal chart" : ""}</span>
      </div>
    `;
    container.appendChild(div);
  });
}

// Update location
document.getElementById("updateLocationBtn").addEventListener("click", async () => {
  const input = prompt("Enter your city, state, and country (USA assumed if missing country):");
  if (!input) return;

  const safeInput = input.trim() + (input.split(",").length === 2 ? ", USA" : "");

  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(safeInput)}`,
      { headers: { "User-Agent": "PlanetaryHoursApp/1.0", "Accept": "application/json" } }
    );
    const data = await response.json();
    if (!data || data.length === 0) { alert("Location not found."); return; }

    saveLocation(parseFloat(data[0].lat), parseFloat(data[0].lon), input);
    loadElectional();
  } catch (err) {
    console.error("Location fetch failed:", err);
    alert("Error retrieving location. Check your internet connection.");
  }
});

// Initial load
loadElectional();
</script>

</body>
</html>
