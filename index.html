<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Planetary Hours - Occult Timekeeping</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Cinzel', serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 100%);
      color: #f0e6d2;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
    
    /* Header */
    header {
      background: linear-gradient(180deg, rgba(26,10,46,0.95) 0%, rgba(10,10,10,0.8) 100%);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid #d4af37;
      padding: 1.5rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(212,175,55,0.3);
    }
    
    h1 {
      text-align: center;
      font-size: 2.5rem;
      color: #d4af37;
      text-shadow: 0 0 20px rgba(212,175,55,0.5);
      margin-bottom: 0.5rem;
      letter-spacing: 2px;
    }
    
    .location-display {
      text-align: center;
      color: #b8a080;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    /* Navigation */
    nav {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 0;
      overflow-x: auto;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    nav button {
      background: linear-gradient(135deg, #1a0a2e 0%, #2d1b4e 100%);
      color: #d4af37;
      border: 1px solid #d4af37;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    nav button:hover {
      background: linear-gradient(135deg, #2d1b4e 0%, #4a2f6e 100%);
      box-shadow: 0 0 15px rgba(212,175,55,0.5);
      transform: translateY(-2px);
    }
    
    nav button.active {
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      color: #1a0a2e;
      box-shadow: 0 0 20px rgba(212,175,55,0.6);
    }
    
    /* Content Sections */
    .view-section {
      display: none;
      padding: 2rem 0;
      animation: fadeIn 0.5s ease;
    }
    
    .view-section.active { display: block; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Hour Cards */
    .hours-grid {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .hour-card {
      background: linear-gradient(135deg, rgba(26,10,46,0.6) 0%, rgba(45,27,78,0.6) 100%);
      border: 2px solid #3a2a5a;
      border-left-width: 6px;
      border-radius: 12px;
      padding: 1.25rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .hour-card:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 20px rgba(212,175,55,0.3);
    }
    
    .hour-card.active {
      background: linear-gradient(135deg, rgba(212,175,55,0.2) 0%, rgba(244,208,63,0.2) 100%);
      border-color: #d4af37;
      box-shadow: 0 0 30px rgba(212,175,55,0.5);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 30px rgba(212,175,55,0.5); }
      50% { box-shadow: 0 0 40px rgba(212,175,55,0.7); }
    }
    
    .hour-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    
    .planet-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .planet-symbol {
      font-size: 2.5rem;
      line-height: 1;
    }
    
    .planet-name {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .hour-time {
      color: #b8a080;
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    
    .hour-details {
      display: grid;
      gap: 0.5rem;
      font-size: 0.9rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(212,175,55,0.3);
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .detail-label {
      color: #b8a080;
      font-size: 0.85rem;
    }
    
    .strength-excellent { color: #4ade80; font-weight: bold; }
    .strength-good { color: #fbbf24; }
    .strength-weak { color: #f87171; }
    
    .resonance-badge {
      background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      display: inline-block;
      margin-top: 0.5rem;
    }
    
    /* Current Hour Display */
    .current-hour-showcase {
      background: linear-gradient(135deg, rgba(212,175,55,0.1) 0%, rgba(139,92,246,0.1) 100%);
      border: 2px solid #d4af37;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      margin-top: 1.5rem;
      box-shadow: 0 8px 40px rgba(212,175,55,0.4);
    }
    
    .current-planet-symbol {
      font-size: 6rem;
      line-height: 1;
      margin-bottom: 1rem;
      text-shadow: 0 0 30px currentColor;
    }
    
    .current-planet-name {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .guidance-section {
      background: rgba(26,10,46,0.6);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 2rem;
      text-align: left;
    }
    
    .guidance-item {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    
    .guidance-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .guidance-title {
      color: #d4af37;
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    
    /* Settings */
    .settings-panel {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .settings-group {
      background: rgba(26,10,46,0.6);
      border: 1px solid #3a2a5a;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .settings-group h3 {
      color: #d4af37;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    
    label {
      display: block;
      color: #b8a080;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    input {
      width: 100%;
      background: rgba(10,10,10,0.8);
      border: 1px solid #3a2a5a;
      border-radius: 8px;
      padding: 0.75rem;
      color: #f0e6d2;
      font-family: inherit;
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    
    input:focus {
      outline: none;
      border-color: #d4af37;
      box-shadow: 0 0 10px rgba(212,175,55,0.3);
    }
    
    button.primary {
      width: 100%;
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      color: #1a0a2e;
      border: none;
      padding: 1rem;
      border-radius: 8px;
      font-family: inherit;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(212,175,55,0.5);
    }
    
    /* Legend Table */
    .legend-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      font-size: 0.85rem;
    }
    
    .legend-table th,
    .legend-table td {
      border: 1px solid #3a2a5a;
      padding: 1rem;
      text-align: left;
    }
    
    .legend-table th {
      background: rgba(212,175,55,0.2);
      color: #d4af37;
      font-weight: bold;
    }
    
    .legend-table tr:nth-child(even) {
      background: rgba(26,10,46,0.3);
    }
    
    /* Natal Chart */
    .natal-grid {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .natal-card {
      background: rgba(26,10,46,0.6);
      border: 1px solid #3a2a5a;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .natal-planet {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .natal-planet-symbol {
      font-size: 2rem;
    }
    
    .natal-zodiac {
      text-align: right;
    }
    
    .natal-zodiac-symbol {
      font-size: 1.5rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      h1 { font-size: 1.8rem; }
      .current-planet-symbol { font-size: 4rem; }
      .current-planet-name { font-size: 1.8rem; }
      nav { gap: 0.25rem; }
      nav button { padding: 0.6rem 1rem; font-size: 0.85rem; }
      .legend-table { font-size: 0.75rem; }
      .legend-table th, .legend-table td { padding: 0.5rem; }
    }
    
    .info-box {
      background: rgba(139,92,246,0.1);
      border: 1px solid #8b5cf6;
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 2rem;
      line-height: 1.6;
    }
    
    .info-box h3 {
      color: #a855f7;
      margin-bottom: 1rem;
    }
    
    .electional-indicator {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      display: inline-block;
      margin-top: 0.25rem;
    }
    
    .excellent { background: #065f46; color: #6ee7b7; }
    .good { background: #78350f; color: #fcd34d; }
    .fair { background: #44403c; color: #d6d3d1; }
    .weak { background: #7f1d1d; color: #fca5a5; }
  </style>
</head>
<body>

<header>
  <div class="container">
    <h1>⊹ PLANETARY HOURS ⊹</h1>
    <div class="location-display" id="locationDisplay">Loading location...</div>
  </div>
</header>

<div class="container">
  <nav>
    <button onclick="showView('hours')" class="active" data-view="hours">Today's Hours</button>
    <button onclick="showView('current')" data-view="current">Current Hour</button>
    <button onclick="showView('electional')" data-view="electional">Electional</button>
    <button onclick="showView('natal')" data-view="natal">Natal Chart</button>
    <button onclick="showView('settings')" data-view="settings">Settings</button>
    <button onclick="showView('legend')" data-view="legend">Correspondences</button>
  </nav>

  <!-- HOURS VIEW -->
  <div id="hours" class="view-section active">
    <h2 style="text-align: center; color: #d4af37; font-size: 1.8rem; margin-bottom: 1rem;">All Planetary Hours Today</h2>
    <div class="hours-grid" id="hoursGrid"></div>
  </div>

  <!-- CURRENT HOUR VIEW -->
  <div id="current" class="view-section">
    <div class="current-hour-showcase" id="currentHourDisplay">
      <p style="color: #b8a080;">No active hour at this moment</p>
    </div>
  </div>

  <!-- ELECTIONAL VIEW -->
  <div id="electional" class="view-section">
    <h2 style="text-align: center; color: #d4af37; font-size: 1.8rem; margin-bottom: 1rem;">Electional Hours Overview</h2>
    <p style="text-align: center; color: #b8a080; margin-bottom: 1.5rem;">Optimal hours for ceremonial operations highlighted by strength and dignity</p>
    <div class="hours-grid" id="electionalGrid"></div>
  </div>

  <!-- NATAL CHART VIEW -->
  <div id="natal" class="view-section">
    <h2 style="text-align: center; color: #d4af37; font-size: 1.8rem; margin-bottom: 1rem;">Natal Chart</h2>
    <div class="natal-grid" id="natalGrid"></div>
  </div>

  <!-- SETTINGS VIEW -->
  <div id="settings" class="view-section">
    <div class="settings-panel">
      <div class="settings-group">
        <h3>Location</h3>
        <label>City, State, Country</label>
        <input type="text" id="locationInput" placeholder="e.g., New York, NY, USA">
        <button class="primary" onclick="updateLocation()">Update Location</button>
      </div>
      
      <div class="settings-group">
        <h3>Birth Data for Natal Chart</h3>
        <label>Date of Birth</label>
        <input type="date" id="birthDate">
        <label>Time of Birth (24-hour format)</label>
        <input type="time" id="birthTime">
        <button class="primary" onclick="saveBirthData()">Save Birth Data</button>
      </div>
    </div>
  </div>

  <!-- LEGEND VIEW -->
  <div id="legend" class="view-section">
    <h2 style="text-align: center; color: #d4af37; font-size: 1.8rem; margin-bottom: 1rem;">Planetary Correspondences</h2>
    
    <table class="legend-table">
      <thead>
        <tr>
          <th>Planet</th>
          <th>Archangel</th>
          <th>Intelligence</th>
          <th>Spirit</th>
          <th>Metal</th>
          <th>Incense</th>
          <th>Crystals</th>
        </tr>
      </thead>
      <tbody id="legendTable"></tbody>
    </table>

    <div class="info-box">
      <h3>Understanding Planetary Hours</h3>
      <p>Planetary hours are an ancient system of sacred timekeeping used in Western occultism for over two millennia. Each day is ruled by one of the seven classical planets, and time is divided into 24 unequal hours based on sunrise and sunset.</p>
      <p style="margin-top: 1rem;">The hours follow the Chaldean order: Saturn, Jupiter, Mars, Sun, Venus, Mercury, Moon. Each planetary hour carries specific energies suited for particular magical operations.</p>
      <p style="margin-top: 1rem;"><strong>Dignities:</strong> Exaltation (strongest), Neutral, Detriment (challenged), Fall (weakest)</p>
      <p style="margin-top: 1rem;"><strong>Natal Resonance:</strong> When a planetary hour's zodiac matches your natal chart position for that planet, the effects are amplified.</p>
    </div>
  </div>
</div>

<script>
// ============================================================================
// STATE & STORAGE
// ============================================================================

let appState = {
  location: { lat: 40.7128, lon: -74.0060, city: "New York, NY" },
  birthData: null,
  hours: [],
  currentHour: null,
  natalChart: null
};

function loadFromStorage() {
  const loc = localStorage.getItem('occult_location');
  const birth = localStorage.getItem('occult_birthData');
  
  if (loc) {
    try { appState.location = JSON.parse(loc); } catch(e) {}
  }
  
  if (birth) {
    try {
      appState.birthData = JSON.parse(birth);
      calculateNatalChart();
    } catch(e) {}
  }
}

function saveToStorage() {
  localStorage.setItem('occult_location', JSON.stringify(appState.location));
  if (appState.birthData) {
    localStorage.setItem('occult_birthData', JSON.stringify(appState.birthData));
  }
}

// ============================================================================
// ASTRONOMICAL CALCULATIONS
// ============================================================================

const RAD = Math.PI / 180;
const DAY_MS = 86400000;
const J1970 = 2440587.5;
const J2000 = 2451545.0;

function toJulian(date) {
  return date.valueOf() / DAY_MS - 0.5 + J1970;
}

function fromJulian(j) {
  return new Date((j + 0.5 - J1970) * DAY_MS);
}

function normalize(deg) {
  return (deg % 360 + 360) % 360;
}

function getSunTimes(date, lat, lon) {
  const phi = RAD * lat;
  const lw = RAD * -lon;
  const d = toJulian(date) - J2000;
  const M = RAD * (357.5291 + 0.98560028 * d);
  const C = RAD * (1.9148 * Math.sin(M) + 0.0200 * Math.sin(2 * M) + 0.0003 * Math.sin(3 * M));
  const P = RAD * 102.9372;
  const L = M + C + P + Math.PI;
  const dec = Math.asin(Math.sin(L) * Math.sin(RAD * 23.44));
  const H = Math.acos((Math.sin(RAD * -0.83) - Math.sin(phi) * Math.sin(dec)) / (Math.cos(phi) * Math.cos(dec)));
  const Jtransit = J2000 + d + lw / (2 * Math.PI);
  
  return {
    sunrise: fromJulian(Jtransit - H / (2 * Math.PI)),
    sunset: fromJulian(Jtransit + H / (2 * Math.PI))
  };
}

function julianDay(date) {
  return date.getTime() / 86400000 + 2440587.5;
}

function planetLongitudes(date) {
  const d = julianDay(date) - 2451545.0;
  const sunL0 = normalize(280.46646 + 0.9856474 * d);
  const sunM = normalize(357.52911 + 0.9856003 * d);
  const sunC = 1.914602 * Math.sin(sunM * RAD);
  const moonL0 = normalize(218.316 + 13.176396 * d);
  const moonM = normalize(134.963 + 13.064993 * d);
  
  return {
    Sun: normalize(sunL0 + sunC),
    Moon: normalize(moonL0 + 6.289 * Math.sin(moonM * RAD)),
    Mercury: normalize(252.250 + 4.09233445 * d),
    Venus: normalize(181.979 + 1.60213034 * d),
    Mars: normalize(355.433 + 0.52403840 * d),
    Jupiter: normalize(34.351 + 0.08308677 * d),
    Saturn: normalize(50.077 + 0.03344414 * d)
  };
}

// ============================================================================
// ZODIAC & DIGNITIES
// ============================================================================

const ZODIAC_SIGNS = [
  { name: "Aries", symbol: "♈", start: 0 },
  { name: "Taurus", symbol: "♉", start: 30 },
  { name: "Gemini", symbol: "♊", start: 60 },
  { name: "Cancer", symbol: "♋", start: 90 },
  { name: "Leo", symbol: "♌", start: 120 },
  { name: "Virgo", symbol: "♍", start: 150 },
  { name: "Libra", symbol: "♎", start: 180 },
  { name: "Scorpio", symbol: "♏", start: 210 },
  { name: "Sagittarius", symbol: "♐", start: 240 },
  { name: "Capricorn", symbol: "♑", start: 270 },
  { name: "Aquarius", symbol: "♒", start: 300 },
  { name: "Pisces", symbol: "♓", start: 330 }
];

function getZodiacFromLongitude(deg) {
  const longitude = normalize(deg);
  for (let i = ZODIAC_SIGNS.length - 1; i >= 0; i--) {
    if (longitude >= ZODIAC_SIGNS[i].start) {
      return ZODIAC_SIGNS[i];
    }
  }
  return ZODIAC_SIGNS[0];
}

const PLANET_EXALTATIONS = {
  Sun: "Aries", Moon: "Taurus", Mercury: "Virgo", Venus: "Pisces",
  Mars: "Capricorn", Jupiter: "Cancer", Saturn: "Libra"
};

const PLANET_DETRIMENTS = {
  Sun: "Libra", Moon: "Scorpio", Mercury: "Pisces", Venus: "Virgo",
  Mars: "Taurus", Jupiter: "Capricorn", Saturn: "Cancer"
};

const PLANET_FALLS = {
  Sun: "Libra", Moon: "Scorpio", Mercury: "Pisces", Venus: "Virgo",
  Mars: "Cancer", Jupiter: "Capricorn", Saturn: "Aries"
};

function getDignity(planet, zodiac) {
  if (zodiac === PLANET_EXALTATIONS[planet]) return "Exaltation";
  if (zodiac === PLANET_DETRIMENTS[planet]) return "Detriment";
  if (zodiac === PLANET_FALLS[planet]) return "Fall";
  return "Neutral";
}

function getHourStrength(planet, zodiac, natalMatch = false) {
  let score = 1;
  const dignity = getDignity(planet, zodiac);
  if (dignity === "Exaltation") score += 2;
  if (dignity === "Neutral") score += 1;
  if (dignity === "Detriment") score -= 1;
  if (dignity === "Fall") score -= 2;
  if (natalMatch) score += 1;
  return score;
}

// ============================================================================
// PLANETARY DATA
// ============================================================================

const CHALDEAN_ORDER = ["Saturn", "Jupiter", "Mars", "Sun", "Venus", "Mercury", "Moon"];
const DAY_RULERS = ["Sun", "Moon", "Mars", "Mercury", "Jupiter", "Venus", "Saturn"];

const PLANET_DETAILS = {
  Sun: { symbol: "☉", color: "#FFD700" },
  Moon: { symbol: "☽", color: "#C0C0C0" },
  Mercury: { symbol: "☿", color: "#FFA500" },
  Venus: { symbol: "♀", color: "#FF69B4" },
  Mars: { symbol: "♂", color: "#FF4500" },
  Jupiter: { symbol: "♃", color: "#4169E1" },
  Saturn: { symbol: "♄", color: "#708090" }
};

const PLANET_CORRESPONDENCES = {
  Saturn: {
    archangel: "Cassiel",
    intelligence: "Agiel",
    spirit: "Zazel",
    metal: "Lead",
    incense: "Galbanum, scammony, pepper-wort, indigo resin",
    crystals: "Sapphire, Onyx, Jet, Lapis Lazuli"
  },
  Jupiter: {
    archangel: "Zadkiel",
    intelligence: "Jophiel",
    spirit: "Hismael",
    metal: "Tin",
    incense: "Nutmeg, cloves, cedar, oak moss",
    crystals: "Amethyst, Lapis Lazuli, Emerald"
  },
  Mars: {
    archangel: "Camael",
    intelligence: "Graphiel",
    spirit: "Barzabel",
    metal: "Iron",
    incense: "Red sanders, cypress, myrrh, ginger",
    crystals: "Ruby, Garnet, Bloodstone, Red Jasper"
  },
  Sun: {
    archangel: "Michael",
    intelligence: "Nachiel",
    spirit: "Sorath",
    metal: "Gold",
    incense: "Frankincense, benzoin, cinnamon, musk",
    crystals: "Topaz, Diamond, Amber, Sunstone"
  },
  Venus: {
    archangel: "Hanael",
    intelligence: "Hagiel",
    spirit: "Kedemel",
    metal: "Copper",
    incense: "Roses, violets, saffron, benzoin",
    crystals: "Emerald, Jade, Rose Quartz, Pearl"
  },
  Mercury: {
    archangel: "Raphael",
    intelligence: "Tiriel",
    spirit: "Taphthartharath",
    metal: "Brass",
    incense: "Cinnamon, mace, lavender, fennel",
    crystals: "Agate, Carnelian, Labradorite, Quartz"
  },
  Moon: {
    archangel: "Gabriel",
    intelligence: "Malcha",
    spirit: "Hasmodai",
    metal: "Silver",
    incense: "Jasmine, willow, sandalwood, cardamom",
    crystals: "Moonstone, Pearl, Selenite, Opal"
  }
};

const PLANET_THEMES = {
  Sun: {
    action: "Authority, illumination, alignment with purpose",
    caution: "Avoid ego-driven action",
    suitable: "Invocation, leadership decisions, consecration of solar talismans"
  },
  Moon: {
    action: "Reflection, memory, psychic sensitivity",
    caution: "Avoid instability or emotional excess",
    suitable: "Divination, scrying, dream work, lunar operations"
  },
  Mercury: {
    action: "Communication, learning, symbolic work",
    caution: "Avoid deception or haste",
    suitable: "Writing, study, sigil construction, mercurial magic"
  },
  Venus: {
    action: "Harmony, attraction, reconciliation",
    caution: "Avoid indulgence",
    suitable: "Love talismans, artistic work, relational magic"
  },
  Mars: {
    action: "Force, separation, courage",
    caution: "Avoid anger and rash acts",
    suitable: "Banishing, defense, decisive action, martial operations"
  },
  Jupiter: {
    action: "Expansion, justice, wisdom",
    caution: "Avoid excess or arrogance",
    suitable: "Blessings, prosperity rites, oaths, legal matters"
  },
  Saturn: {
    action: "Restriction, endurance, structure",
    caution: "Avoid melancholy",
    suitable: "Bindings, discipline, long-term planning, saturnine work"
  }
};

const SIGN_MODIFIERS = {
  Aries: "direct and forceful",
  Taurus: "stable and material",
  Gemini: "intellectual and fluid",
  Cancer: "protective and internal",
  Leo: "expressive and radiant",
  Virgo: "precise and corrective",
  Libra: "balanced and relational",
  Scorpio: "intense and transformative",
  Sagittarius: "aspirational and expansive",
  Capricorn: "structured and disciplined",
  Aquarius: "detached and innovative",
  Pisces: "visionary and dissolving"
};

// ============================================================================
// PLANETARY HOURS GENERATION
// ============================================================================

function generatePlanetaryHours(dayRuler, sunrise, sunset) {
  const hours = [];
  const nextSunrise = new Date(sunrise.getTime() + 24 * 60 * 60 * 1000);
  const dayLength = (sunset - sunrise) / 12;
  const nightLength = (nextSunrise - sunset) / 12;
  let startIndex = CHALDEAN_ORDER.indexOf(dayRuler);
  if (startIndex === -1) startIndex = 0;

  for (let i = 0; i < 24; i++) {
    const planetIndex = (startIndex + i) % 7;
    const planetName = CHALDEAN_ORDER[planetIndex];
    const planet = PLANET_DETAILS[planetName];
    const start = new Date(i < 12 ? sunrise.getTime() + i * dayLength : sunset.getTime() + (i - 12) * nightLength);
    const end = new Date(i < 12 ? sunrise.getTime() + (i + 1) * dayLength : sunset.getTime() + (i - 11) * nightLength);
    hours.push({ 
      planet: { name: planetName, symbol: planet.symbol, color: planet.color }, 
      start, 
      end 
    });
  }
  return hours;
}

// ============================================================================
// MAIN CALCULATION FUNCTIONS
// ============================================================================

function calculateHours() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const dayRuler = DAY_RULERS[today.getDay()];
  
  try {
    const sunTimes = getSunTimes(today, appState.location.lat, appState.location.lon);
    const planetaryHours = generatePlanetaryHours(dayRuler, sunTimes.sunrise, sunTimes.sunset);
    
    appState.hours = planetaryHours.map(h => {
      const zodiac = getZodiacFromLongitude(planetLongitudes(h.start)[h.planet.name]);
      let natalMatch = false;
      
      if (appState.birthData) {
        const natalDate = new Date(`${appState.birthData.date}T${appState.birthData.time}`);
        const natalLongs = planetLongitudes(natalDate);
        const natalZodiac = getZodiacFromLongitude(natalLongs[h.planet.name]);
        natalMatch = natalZodiac.name === zodiac.name;
      }
      
      const dignity = getDignity(h.planet.name, zodiac.name);
      const strength = getHourStrength(h.planet.name, zodiac.name, natalMatch);
      
      return { ...h, zodiac, dignity, strength, natalMatch };
    });
    
    appState.currentHour = appState.hours.find(h => now >= h.start && now < h.end);
    renderCurrentView();
  } catch (error) {
    console.error('Error calculating hours:', error);
  }
}

function calculateNatalChart() {
  if (!appState.birthData) return;
  
  try {
    const natalDate = new Date(`${appState.birthData.date}T${appState.birthData.time}`);
    const longs = planetLongitudes(natalDate);
    appState.natalChart = Object.keys(longs).map(planet => ({
      planet,
      longitude: longs[planet],
      zodiac: getZodiacFromLongitude(longs[planet])
    }));
  } catch (error) {
    console.error('Error calculating natal chart:', error);
  }
}

// ============================================================================
// UI RENDERING
// ============================================================================

function formatTime(date) {
  return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function getStrengthClass(strength) {
  if (strength > 2) return 'strength-excellent';
  if (strength > 0) return 'strength-good';
  return 'strength-weak';
}

function getStrengthText(strength) {
  if (strength > 2) return 'Excellent';
  if (strength > 0) return 'Good';
  return 'Weak';
}

function renderHoursView() {
  const grid = document.getElementById('hoursGrid');
  const now = new Date();
  
  grid.innerHTML = appState.hours.map(h => {
    const isActive = now >= h.start && now < h.end;
    return `
      <div class="hour-card ${isActive ? 'active' : ''}" style="border-left-color: ${h.planet.color}">
        <div class="hour-header">
          <div class="planet-info">
            <div class="planet-symbol" style="color: ${h.planet.color}">${h.planet.symbol}</div>
            <div>
              <div class="planet-name" style="color: ${h.planet.color}">${h.planet.name}</div>
              <div class="hour-time">${formatTime(h.start)} - ${formatTime(h.end)}</div>
            </div>
          </div>
        </div>
        <div class="hour-details">
          <div class="detail-row">
            <span class="detail-label">Zodiac</span>
            <span>${h.zodiac.symbol} ${h.zodiac.name}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Dignity</span>
            <span>${h.dignity}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Strength</span>
            <span class="${getStrengthClass(h.strength)}">${getStrengthText(h.strength)} (${h.strength})</span>
          </div>
        </div>
        ${h.natalMatch ? '<div class="resonance-badge">★ Natal Resonance</div>' : ''}
      </div>
    `;
  }).join('');
}

function renderCurrentHour() {
  const display = document.getElementById('currentHourDisplay');
  
  if (!appState.currentHour) {
    display.innerHTML = '<p style="color: #b8a080;">No active hour at this moment</p>';
    return;
  }
  
  const h = appState.currentHour;
  const theme = PLANET_THEMES[h.planet.name];
  const corr = PLANET_CORRESPONDENCES[h.planet.name];
  
  display.innerHTML = `
    <div class="current-planet-symbol" style="color: ${h.planet.color}">${h.planet.symbol}</div>
    <div class="current-planet-name" style="color: ${h.planet.color}">${h.planet.name}</div>
    <div style="font-size: 1.2rem; color: #b8a080; margin-bottom: 0.5rem;">
      ${formatTime(h.start)} - ${formatTime(h.end)}
    </div>
    <div style="font-size: 1.5rem; margin-bottom: 1rem;">
      ${h.zodiac.symbol} ${h.zodiac.name}
    </div>
    
    <div class="guidance-section">
      <div class="guidance-item">
        <div class="guidance-title">Archangel</div>
        <div>${corr.archangel}</div>
      </div>
      <div class="guidance-item">
        <div class="guidance-title">Intelligence & Spirit</div>
        <div>${corr.intelligence} / ${corr.spirit}</div>
      </div>
      <div class="guidance-item">
        <div class="guidance-title">Primary Current</div>
        <div>${theme.action}</div>
        <div style="color: #b8a080; margin-top: 0.5rem;">Expression is ${SIGN_MODIFIERS[h.zodiac.name]}</div>
      </div>
      <div class="guidance-item">
        <div class="guidance-title">Suitable Works</div>
        <div>${theme.suitable}</div>
      </div>
      <div class="guidance-item">
        <div class="guidance-title">Caution</div>
        <div style="color: #f87171;">${theme.caution}</div>
      </div>
      <div class="guidance-item">
        <div class="guidance-title">Magical Correspondences</div>
        <div><strong>Metal:</strong> ${corr.metal}</div>
        <div><strong>Incense:</strong> ${corr.incense}</div>
        <div><strong>Crystals:</strong> ${corr.crystals}</div>
      </div>
      <div class="guidance-item">
        <div class="guidance-title">Dignity & Strength</div>
        <div>${h.dignity} - Strength: ${h.strength}</div>
      </div>
      ${h.natalMatch ? '<div class="resonance-badge" style="margin-top: 1rem;">★ This hour resonates with your natal chart</div>' : ''}
    </div>
  `;
}

function renderElectional() {
  const grid = document.getElementById('electionalGrid');
  const now = new Date();
  
  grid.innerHTML = appState.hours.map(h => {
    const isActive = now >= h.start && now < h.end;
    const opacity = Math.min(0.9, 0.2 + h.strength / 4);
    let qualityClass = 'fair';
    if (h.strength > 2) qualityClass = 'excellent';
    else if (h.strength > 0) qualityClass = 'good';
    else if (h.strength < 0) qualityClass = 'weak';
    
    return `
      <div class="hour-card ${isActive ? 'active' : ''}" style="border-left-color: ${h.planet.color}; background: rgba(26,10,46,${opacity * 0.6})">
        <div class="hour-header">
          <div class="planet-info">
            <div class="planet-symbol" style="color: ${h.planet.color}">${h.planet.symbol}</div>
            <div>
              <div class="planet-name" style="color: ${h.planet.color}">${h.planet.name}</div>
              <div class="hour-time">${formatTime(h.start)} - ${formatTime(h.end)}</div>
            </div>
          </div>
          <div style="text-align: right;">
            <div>${h.zodiac.symbol} ${h.zodiac.name}</div>
            <div class="electional-indicator ${qualityClass}">${getStrengthText(h.strength)}</div>
            ${h.natalMatch ? '<div class="electional-indicator" style="background: #581c87; color: #e9d5ff; margin-top: 0.25rem;">Resonant</div>' : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderNatal() {
  const grid = document.getElementById('natalGrid');
  
  if (!appState.natalChart) {
    grid.innerHTML = '<div style="text-align: center; color: #b8a080; padding: 2rem;">No birth data set. Go to Settings to enter your birth information.</div>';
    return;
  }
  
  grid.innerHTML = appState.natalChart.map(item => `
    <div class="natal-card">
      <div class="natal-planet">
        <div class="natal-planet-symbol" style="color: ${PLANET_DETAILS[item.planet].color}">
          ${PLANET_DETAILS[item.planet].symbol}
        </div>
        <div>
          <div style="font-weight: bold; font-size: 1.1rem;">${item.planet}</div>
          <div style="color: #b8a080; font-size: 0.85rem;">${item.longitude.toFixed(2)}°</div>
        </div>
      </div>
      <div class="natal-zodiac">
        <div class="natal-zodiac-symbol">${item.zodiac.symbol}</div>
        <div style="font-size: 0.9rem;">${item.zodiac.name}</div>
      </div>
    </div>
  `).join('');
}

function renderLegend() {
  const table = document.getElementById('legendTable');
  
  table.innerHTML = Object.entries(PLANET_CORRESPONDENCES).map(([planet, data]) => `
    <tr>
      <td><span style="color: ${PLANET_DETAILS[planet].color}">${PLANET_DETAILS[planet].symbol} ${planet}</span></td>
      <td>${data.archangel}</td>
      <td>${data.intelligence}</td>
      <td>${data.spirit}</td>
      <td>${data.metal}</td>
      <td>${data.incense}</td>
      <td>${data.crystals}</td>
    </tr>
  `).join('');
}

function renderCurrentView() {
  const activeView = document.querySelector('.view-section.active').id;
  
  document.getElementById('locationDisplay').textContent = appState.location.city;
  
  switch(activeView) {
    case 'hours':
      renderHoursView();
      break;
    case 'current':
      renderCurrentHour();
      break;
    case 'electional':
      renderElectional();
      break;
    case 'natal':
      renderNatal();
      break;
    case 'legend':
      renderLegend();
      break;
  }
}

// ============================================================================
// UI INTERACTIONS
// ============================================================================

function showView(viewName) {
  document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
  
  document.getElementById(viewName).classList.add('active');
  document.querySelector(`nav button[data-view="${viewName}"]`).classList.add('active');
  
  renderCurrentView();
}

async function updateLocation() {
  const input = document.getElementById('locationInput').value.trim();
  if (!input) return;
  
  const query = input.includes(',') && input.split(',').length > 2 ? input : `${input}, USA`;
  
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`,
      { headers: { "User-Agent": "PlanetaryHoursApp/2.0" } }
    );
    
    const data = await response.json();
    if (data && data.length > 0) {
      appState.location = {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon),
        city: input
      };
      saveToStorage();
      calculateHours();
      alert('Location updated successfully!');
    } else {
      alert('Location not found. Please try again.');
    }
  } catch (error) {
    console.error('Error updating location:', error);
    alert('Error retrieving location. Check your internet connection.');
  }
}

function saveBirthData() {
  const date = document.getElementById('birthDate').value;
  const time = document.getElementById('birthTime').value;
  
  if (!date || !time) {
    alert('Please enter both date and time');
    return;
  }
  
  appState.birthData = { date, time };
  saveToStorage();
  calculateNatalChart();
  calculateHours();
  alert('Birth data saved successfully!');
}

// ============================================================================
// INITIALIZATION
// ============================================================================

function init() {
  loadFromStorage();
  
  if (appState.birthData) {
    document.getElementById('birthDate').value = appState.birthData.date;
    document.getElementById('birthTime').value = appState.birthData.time;
  }
  
  document.getElementById('locationInput').value = appState.location.city;
  
  calculateHours();
  renderLegend();
  
  setInterval(calculateHours, 60000);
}

// Start the app
init();

// Service Worker for offline support
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>

</body>
</html
