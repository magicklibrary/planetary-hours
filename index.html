<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planetary Hours - Occult Timekeeping</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Georgia, serif; overflow-x: hidden; }
    input, button, select { font-family: inherit; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // SWISS EPHEMERIS - HIGH PRECISION ASTRONOMICAL CALCULATIONS
    const RAD = Math.PI / 180;
    const DEG = 180 / Math.PI;
    const J2000 = 2451545.0;

    function getJulianDay(date) {
      const y = date.getFullYear();
      const m = date.getMonth() + 1;
      const d = date.getDate() + date.getHours() / 24 + date.getMinutes() / 1440 + date.getSeconds() / 86400;
      
      let a = Math.floor((14 - m) / 12);
      let y2 = y + 4800 - a;
      let m2 = m + 12 * a - 3;
      
      return d + Math.floor((153 * m2 + 2) / 5) + 365 * y2 + Math.floor(y2 / 4) - Math.floor(y2 / 100) + Math.floor(y2 / 400) - 32045;
    }

    function getSunPosition(jd) {
      const T = (jd - J2000) / 36525;
      const L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T * T;
      const M = 357.52911 + 35999.05029 * T - 0.0001537 * T * T;
      const e = 0.016708634 - 0.000042037 * T - 0.0000001267 * T * T;
      
      const C = (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(M * RAD)
              + (0.019993 - 0.000101 * T) * Math.sin(2 * M * RAD)
              + 0.000289 * Math.sin(3 * M * RAD);
      
      const theta = L0 + C;
      const omega = 125.04 - 1934.136 * T;
      const lambda = theta - 0.00569 - 0.00478 * Math.sin(omega * RAD);
      
      return ((lambda % 360) + 360) % 360;
    }

    function getMoonPosition(jd) {
      const T = (jd - J2000) / 36525;
      const L = 218.3164477 + 481267.88123421 * T - 0.0015786 * T * T + 0.00000181 * T * T * T;
      const D = 297.8501921 + 445267.1114034 * T - 0.0018819 * T * T + 0.000000180 * T * T * T;
      const M = 357.5291092 + 35999.0502909 * T - 0.0001536 * T * T + 0.00000004 * T * T * T;
      const Mp = 134.9633964 + 477198.8675055 * T + 0.0087414 * T * T + 0.000014 * T * T * T;
      const F = 93.2720950 + 483202.0175233 * T - 0.0036539 * T * T - 0.00000028 * T * T * T;
      
      const longitude = L 
        + 6.288774 * Math.sin(Mp * RAD)
        + 1.274027 * Math.sin((2 * D - Mp) * RAD)
        + 0.658314 * Math.sin(2 * D * RAD)
        + 0.213618 * Math.sin(2 * Mp * RAD)
        - 0.185116 * Math.sin(M * RAD)
        - 0.114332 * Math.sin(2 * F * RAD);
      
      return ((longitude % 360) + 360) % 360;
    }

    function getPlanetPosition(planet, jd) {
      const T = (jd - J2000) / 36525;
      
      const elements = {
        Mercury: { 
          L: 252.250906 + 149472.6746358 * T - 0.00000536 * T * T,
          a: 0.38709893 + 0.00000066 * T,
          e: 0.20563069 + 0.00002527 * T,
          i: 7.00487 - 0.00000594 * T,
          Om: 48.33167 - 0.12214182 * T,
          w: 77.45645 + 0.15940013 * T
        },
        Venus: { 
          L: 181.979801 + 58517.8156760 * T + 0.00000165 * T * T,
          a: 0.72333199 + 0.00000092 * T,
          e: 0.00677323 - 0.00004938 * T,
          i: 3.39471 - 0.00000002 * T,
          Om: 76.68069 - 0.27274174 * T,
          w: 131.53298 - 0.00000108 * T
        },
        Mars: { 
          L: 355.433000 + 19139.8585209 * T + 0.00000261 * T * T,
          a: 1.52366231 - 0.00007221 * T,
          e: 0.09341233 + 0.00011902 * T,
          i: 1.85061 - 0.00000608 * T,
          Om: 49.57854 - 0.29257343 * T,
          w: 336.04084 + 0.44441088 * T
        },
        Jupiter: { 
          L: 34.351519 + 3034.9056606 * T - 0.00008501 * T * T,
          a: 5.20336301 + 0.00060737 * T,
          e: 0.04839266 - 0.00012880 * T,
          i: 1.30530 - 0.00000056 * T,
          Om: 100.55615 + 1.02173666 * T,
          w: 14.75385 + 0.21252668 * T
        },
        Saturn: { 
          L: 50.077444 + 1222.1138488 * T + 0.00021004 * T * T,
          a: 9.53707032 - 0.00301530 * T,
          e: 0.05415060 - 0.00036762 * T,
          i: 2.48446 + 0.00000004 * T,
          Om: 113.71504 - 0.28867794 * T,
          w: 92.43194 - 0.41897216 * T
        }
      };
      
      const elem = elements[planet];
      if (!elem) return 0;
      
      const M = ((elem.L - elem.w) % 360 + 360) % 360;
      const E = M + elem.e * DEG * Math.sin(M * RAD);
      const v = 2 * Math.atan(Math.sqrt((1 + elem.e) / (1 - elem.e)) * Math.tan(E * RAD / 2)) * DEG;
      const L = ((v + elem.w) % 360 + 360) % 360;
      
      return L;
    }

    function getAllPlanetPositions(date) {
      const jd = getJulianDay(date);
      return {
        Sun: getSunPosition(jd),
        Moon: getMoonPosition(jd),
        Mercury: getPlanetPosition('Mercury', jd),
        Venus: getPlanetPosition('Venus', jd),
        Mars: getPlanetPosition('Mars', jd),
        Jupiter: getPlanetPosition('Jupiter', jd),
        Saturn: getPlanetPosition('Saturn', jd)
      };
    }

    function getSunTimes(date, lat, lon) {
      const jd = getJulianDay(date);
      const n = jd - J2000 + 0.0008;
      const J = n - lon / 360;
      const M = (357.5291 + 0.98560028 * J) % 360;
      const C = 1.9148 * Math.sin(M * RAD) + 0.0200 * Math.sin(2 * M * RAD) + 0.0003 * Math.sin(3 * M * RAD);
      const lambda = (M + C + 180 + 102.9372) % 360;
      const Jtransit = J2000 + J + 0.0053 * Math.sin(M * RAD) - 0.0069 * Math.sin(2 * lambda * RAD);
      
      const delta = Math.asin(Math.sin(lambda * RAD) * Math.sin(23.44 * RAD));
      const omega = Math.acos((Math.sin(-0.83 * RAD) - Math.sin(lat * RAD) * Math.sin(delta)) / (Math.cos(lat * RAD) * Math.cos(delta)));
      
      if (isNaN(omega)) {
        return { sunrise: new Date(date), sunset: new Date(date) };
      }
      
      const Jrise = Jtransit - omega * DEG / 360;
      const Jset = Jtransit + omega * DEG / 360;
      
      return {
        sunrise: new Date((Jrise - 2440587.5) * 86400000),
        sunset: new Date((Jset - 2440587.5) * 86400000)
      };
    }

    const CHALDEAN_ORDER = ["Saturn", "Jupiter", "Mars", "Sun", "Venus", "Mercury", "Moon"];
    const DAY_RULERS = ["Sun", "Moon", "Mars", "Mercury", "Jupiter", "Venus", "Saturn"];

    const DAY_COLORS = {
      Sun: { bg: '#1a0a00', primary: '#FFD700', secondary: '#FFA500' },
      Moon: { bg: '#0a0a1a', primary: '#C0C0C0', secondary: '#E8E8E8' },
      Mars: { bg: '#1a0000', primary: '#FF4500', secondary: '#DC143C' },
      Mercury: { bg: '#1a0f00', primary: '#FFA500', secondary: '#FFB347' },
      Jupiter: { bg: '#00001a', primary: '#4169E1', secondary: '#1E90FF' },
      Venus: { bg: '#001a0a', primary: '#00FF7F', secondary: '#98FB98' },
      Saturn: { bg: '#000000', primary: '#708090', secondary: '#A9A9A9' }
    };

    const PLANET_DETAILS = {
      Sun: { symbol: "‚òâ", color: "#FFD700" },
      Moon: { symbol: "‚òΩ", color: "#C0C0C0" },
      Mercury: { symbol: "‚òø", color: "#FFA500" },
      Venus: { symbol: "‚ôÄ", color: "#00FF7F" },
      Mars: { symbol: "‚ôÇ", color: "#FF4500" },
      Jupiter: { symbol: "‚ôÉ", color: "#4169E1" },
      Saturn: { symbol: "‚ôÑ", color: "#708090" }
    };

    const ZODIAC_SIGNS = [
      { name: "Aries", symbol: "‚ôà", start: 0, element: "Fire", quality: "Cardinal" },
      { name: "Taurus", symbol: "‚ôâ", start: 30, element: "Earth", quality: "Fixed" },
      { name: "Gemini", symbol: "‚ôä", start: 60, element: "Air", quality: "Mutable" },
      { name: "Cancer", symbol: "‚ôã", start: 90, element: "Water", quality: "Cardinal" },
      { name: "Leo", symbol: "‚ôå", start: 120, element: "Fire", quality: "Fixed" },
      { name: "Virgo", symbol: "‚ôç", start: 150, element: "Earth", quality: "Mutable" },
      { name: "Libra", symbol: "‚ôé", start: 180, element: "Air", quality: "Cardinal" },
      { name: "Scorpio", symbol: "‚ôè", start: 210, element: "Water", quality: "Fixed" },
      { name: "Sagittarius", symbol: "‚ôê", start: 240, element: "Fire", quality: "Mutable" },
      { name: "Capricorn", symbol: "‚ôë", start: 270, element: "Earth", quality: "Cardinal" },
      { name: "Aquarius", symbol: "‚ôí", start: 300, element: "Air", quality: "Fixed" },
      { name: "Pisces", symbol: "‚ôì", start: 330, element: "Water", quality: "Mutable" }
    ];

    const PLANET_DIGNITIES = {
      Sun: { rulership: ["Leo"], exaltation: "Aries", detriment: "Aquarius", fall: "Libra" },
      Moon: { rulership: ["Cancer"], exaltation: "Taurus", detriment: "Capricorn", fall: "Scorpio" },
      Mercury: { rulership: ["Gemini", "Virgo"], exaltation: "Virgo", detriment: "Sagittarius", fall: "Pisces" },
      Venus: { rulership: ["Taurus", "Libra"], exaltation: "Pisces", detriment: "Aries", fall: "Virgo" },
      Mars: { rulership: ["Aries", "Scorpio"], exaltation: "Capricorn", detriment: "Libra", fall: "Cancer" },
      Jupiter: { rulership: ["Sagittarius", "Pisces"], exaltation: "Cancer", detriment: "Gemini", fall: "Capricorn" },
      Saturn: { rulership: ["Capricorn", "Aquarius"], exaltation: "Libra", detriment: "Cancer", fall: "Aries" }
    };

    const CORRESPONDENCES = {
      Saturn: {
        archangel: "Cassiel", intelligence: "Agiel", spirit: "Zazel",
        metal: "Lead", incense: "Myrrh, patchouli", crystals: "Onyx, Obsidian",
        suitable: "Bindings, protection, discipline, banishing, necromancy",
        operations: ["Binding spells", "Protection rituals", "Banishing unwanted influences", "Working with ancestors", "Discipline and structure work"],
        dayHourBonus: false
      },
      Jupiter: {
        archangel: "Zadkiel", intelligence: "Iophiel", spirit: "Hismael",
        metal: "Tin", incense: "Cedar, sage", crystals: "Amethyst, Lapis",
        suitable: "Wealth, expansion, legal matters, wisdom, growth",
        operations: ["Prosperity magic", "Legal success", "Business expansion", "Higher learning", "Philosophical pursuits"],
        dayHourBonus: true
      },
      Sun: {
        archangel: "Michael", intelligence: "Nakhiel", spirit: "Sorath",
        metal: "Gold", incense: "Frankincense, cinnamon", crystals: "Citrine, Sunstone",
        suitable: "Success, authority, healing, illumination, vitality",
        operations: ["Success magic", "Authority and power", "Solar healing", "Enlightenment work", "Vitality enhancement"],
        dayHourBonus: true
      },
      Venus: {
        archangel: "Haniel", intelligence: "Hagiel", spirit: "Kedemel",
        metal: "Copper", incense: "Rose, benzoin", crystals: "Emerald, Rose Quartz",
        suitable: "Love, beauty, art, harmony, relationships",
        operations: ["Love spells", "Beauty magic", "Artistic inspiration", "Harmony restoration", "Relationship healing"],
        dayHourBonus: true
      },
      Mercury: {
        archangel: "Raphael", intelligence: "Tiriel", spirit: "Taphthartharath",
        metal: "Mercury/Quicksilver", incense: "Lavender, dittany", crystals: "Agate, Aventurine",
        suitable: "Communication, learning, travel, divination, commerce",
        operations: ["Communication enhancement", "Study and learning", "Travel magic", "Divination", "Business dealings"],
        dayHourBonus: true
      },
      Moon: {
        archangel: "Gabriel", intelligence: "Malkah be-Tarshishim", spirit: "Chasmodai",
        metal: "Silver", incense: "Jasmine, lotus", crystals: "Moonstone, Selenite",
        suitable: "Dreams, intuition, psychic work, emotions, cycles",
        operations: ["Dream work", "Psychic development", "Emotional healing", "Lunar cycles", "Scrying and vision"],
        dayHourBonus: false
      },
      Mars: {
        archangel: "Camael", intelligence: "Graphiel", spirit: "Bartzabel",
        metal: "Iron", incense: "Dragon's blood, tobacco", crystals: "Ruby, Garnet",
        suitable: "Courage, victory, conflict, protection, strength",
        operations: ["Courage rituals", "Victory magic", "Conflict resolution", "Physical strength", "Warrior energy work"],
        dayHourBonus: true
      }
    };

    function getZodiacFromLongitude(deg) {
      const longitude = ((deg % 360) + 360) % 360;
      for (let i = ZODIAC_SIGNS.length - 1; i >= 0; i--) {
        if (longitude >= ZODIAC_SIGNS[i].start) return ZODIAC_SIGNS[i];
      }
      return ZODIAC_SIGNS[0];
    }

    function getDignity(planet, zodiacName) {
      const dig = PLANET_DIGNITIES[planet];
      if (!dig) return "Neutral";
      if (dig.rulership && dig.rulership.includes(zodiacName)) return "Rulership";
      if (zodiacName === dig.exaltation) return "Exaltation";
      if (zodiacName === dig.detriment) return "Detriment";
      if (zodiacName === dig.fall) return "Fall";
      return "Neutral";
    }

    function calculateRitualPower(hour, natalChart) {
      let power = 50;
      
      const dignity = getDignity(hour.planet.name, hour.zodiac.name);
      if (dignity === "Rulership") power += 25;
      else if (dignity === "Exaltation") power += 20;
      else if (dignity === "Neutral") power += 10;
      else if (dignity === "Detriment") power -= 15;
      else if (dignity === "Fall") power -= 20;
      
      const corr = CORRESPONDENCES[hour.planet.name];
      if (corr.dayHourBonus && hour.isDayHour) power += 10;
      if (!corr.dayHourBonus && !hour.isDayHour) power += 10;
      
      if (natalChart) {
        const natalPlanet = natalChart.find(p => p.planet === hour.planet.name);
        if (natalPlanet) {
          if (natalPlanet.zodiac.name === hour.zodiac.name) power += 30;
          else if (natalPlanet.zodiac.element === hour.zodiac.element) power += 15;
        }
      }
      
      if (hour.zodiac.quality === "Cardinal") power += 5;
      else if (hour.zodiac.quality === "Fixed") power += 10;
      
      return Math.max(0, Math.min(100, power));
    }

    function getRitualTier(power) {
      if (power >= 90) return { tier: "S", label: "Supreme", color: "#FFD700", desc: "Exceptional power - Ideal for major operations" };
      if (power >= 75) return { tier: "A", label: "Excellent", color: "#C0C0C0", desc: "Very strong - Perfect for important work" };
      if (power >= 60) return { tier: "B", label: "Good", color: "#CD7F32", desc: "Solid power - Recommended for general work" };
      if (power >= 40) return { tier: "C", label: "Fair", color: "#4169E1", desc: "Moderate - Acceptable for routine operations" };
      if (power >= 25) return { tier: "D", label: "Weak", color: "#9370DB", desc: "Low power - Best avoided if possible" };
      return { tier: "F", label: "Poor", color: "#696969", desc: "Very weak - Not recommended" };
    }

    function generatePlanetaryHours(dayRuler, sunrise, sunset, natalChart) {
      const hours = [];
      const nextSunrise = new Date(sunrise.getTime() + 24 * 60 * 60 * 1000);
      const dayLength = (sunset - sunrise) / 12;
      const nightLength = (nextSunrise - sunset) / 12;
      
      let startIndex = CHALDEAN_ORDER.indexOf(dayRuler);
      if (startIndex === -1) startIndex = 0;

      for (let i = 0; i < 24; i++) {
        const planetIndex = (startIndex + i) % 7;
        const planetName = CHALDEAN_ORDER[planetIndex];
        const planet = PLANET_DETAILS[planetName];
        
        let start, end;
        if (i < 12) {
          start = new Date(sunrise.getTime() + i * dayLength);
          end = new Date(sunrise.getTime() + (i + 1) * dayLength);
        } else {
          start = new Date(sunset.getTime() + (i - 12) * nightLength);
          end = new Date(sunset.getTime() + (i - 11) * nightLength);
        }
        
        const positions = getAllPlanetPositions(start);
        const zodiac = getZodiacFromLongitude(positions[planetName]);
        const dignity = getDignity(planetName, zodiac.name);
        const isDayHour = i < 12;
        
        const hourData = { 
          planet: { name: planetName, ...planet },
          start, end, zodiac, dignity,
          isDayHour,
          hourNumber: i + 1,
          positions
        };
        
        const power = calculateRitualPower(hourData, natalChart);
        const tier = getRitualTier(power);
        
        hours.push({ ...hourData, power, tier });
      }
      
      return hours;
    }

    async function getAIRitualGuidance(hour, natalChart) {
      // SECURITY NOTE: This function is OPTIONAL and only runs when user clicks a specific hour
      // It sends ONLY: planet name, zodiac sign, dignity, and power calculation
      // NO personal data, birth info, or location is transmitted
      // User can use the app fully offline - AI guidance is an optional enhancement
      
      const prompt = `As an expert in ceremonial magic and astrological timing, provide 3 specific ritual operations for this planetary hour.

CURRENT CONDITIONS:
Planetary Hour: ${hour.planet.name}
Zodiac: ${hour.zodiac.name} (${hour.zodiac.element}, ${hour.zodiac.quality})
Dignity: ${hour.dignity}
Time: ${hour.isDayHour ? 'Day' : 'Night'}
Ritual Power: ${hour.power}/100 (Tier ${hour.tier.tier})

CORRESPONDENCES:
Operations: ${CORRESPONDENCES[hour.planet.name].operations.join(', ')}
Archangel: ${CORRESPONDENCES[hour.planet.name].archangel}
Incense: ${CORRESPONDENCES[hour.planet.name].incense}
Crystals: ${CORRESPONDENCES[hour.planet.name].crystals}

Provide response as JSON only:
{
  "suggestions": [
    {
      "title": "Brief operation name",
      "description": "2-3 sentence practical description",
      "materials": "Key materials needed",
      "timing": "Why this hour is ideal"
    }
  ]
}`;

      try {
        // Timeout protection - abort request after 10 seconds
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            // NOTE: API key is handled by Claude.ai artifact environment
            // No sensitive credentials are exposed in this code
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            messages: [{ role: "user", content: prompt }]
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        const text = data.content?.find(c => c.type === "text")?.text || "{}";
        const clean = text.replace(/```json\n?|\n?```/g, "").trim();
        
        // Safely parse JSON with error handling
        try {
          return JSON.parse(clean);
        } catch (parseError) {
          console.error('JSON parse error:', parseError);
          throw parseError;
        }
      } catch (error) {
        console.error('AI guidance error:', error);
        // Graceful fallback - app continues working without AI
        return {
          suggestions: [
            {
              title: CORRESPONDENCES[hour.planet.name].operations[0],
              description: `Perform ${hour.planet.name} work during this ${hour.dignity} hour in ${hour.zodiac.name}. The ${hour.tier.label} power level makes this ${hour.tier.desc.toLowerCase()}.`,
              materials: `${CORRESPONDENCES[hour.planet.name].incense}, ${CORRESPONDENCES[hour.planet.name].crystals}`,
              timing: `${hour.isDayHour ? 'Day' : 'Night'} hour with ${hour.power}% power`
            }
          ]
        };
      }
    }

    function ScryingScreen({ onExit, planetColor }) {
      const canvasRef = useRef(null);
      const [showExit, setShowExit] = useState(true);

      useEffect(() => {
        let timeoutId;
        const handleInteraction = () => {
          setShowExit(true);
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => setShowExit(false), 3000);
        };

        window.addEventListener('mousemove', handleInteraction);
        window.addEventListener('touchstart', handleInteraction);
        
        timeoutId = setTimeout(() => setShowExit(false), 3000);
        
        return () => {
          window.removeEventListener('mousemove', handleInteraction);
          window.removeEventListener('touchstart', handleInteraction);
          clearTimeout(timeoutId);
        };
      }, []);

      useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let frame = 0;
        let animationId;

        function animate() {
          ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          
          for (let i = 0; i < data.length; i += 4) {
            if (Math.random() > 0.97) {
              const noise = Math.random() * 120;
              data[i] = noise;
              data[i + 1] = noise;
              data[i + 2] = noise;
            }
          }
          
          ctx.putImageData(imageData, 0, 0);

          for (let y = 0; y < canvas.height; y += 3) {
            ctx.fillStyle = `rgba(0, 0, 0, ${0.15 + Math.sin(frame * 0.01 + y * 0.05) * 0.1})`;
            ctx.fillRect(0, y, canvas.width, 2);
          }

          if (Math.random() > 0.92) {
            const hexToRgb = (hex) => {
              const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
              return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
              } : { r: 255, g: 255, b: 255 };
            };
            const rgb = hexToRgb(planetColor);
            ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.05)`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
          }

          frame++;
          animationId = requestAnimationFrame(animate);
        }

        animate();
        
        return () => {
          if (animationId) cancelAnimationFrame(animationId);
        };
      }, [planetColor]);

      return (
        <div style={{
          position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
          background: '#000', zIndex: 3000
        }}>
          <canvas ref={canvasRef} style={{ width: '100%', height: '100%', display: 'block' }} />
          {showExit && (
            <button onClick={onExit} style={{
              position: 'absolute', top: 20, right: 20, background: '#dc2626',
              color: 'white', border: 'none', padding: '1rem 2rem', borderRadius: 8,
              fontSize: '1rem', fontWeight: 'bold', cursor: 'pointer', zIndex: 3001,
              boxShadow: '0 4px 20px rgba(220, 38, 38, 0.5)'
            }}>
              Exit Scrying
            </button>
          )}
        </div>
      );
    }

    function PlanetaryHoursApp() {
      const [location, setLocation] = useState({ lat: 40.7128, lon: -74.0060, city: "New York, NY, USA" });
      const [hours, setHours] = useState([]);
      const [currentHour, setCurrentHour] = useState(null);
      const [birthData, setBirthData] = useState(null);
      const [natalChart, setNatalChart] = useState(null);
      const [activeView, setActiveView] = useState('hours');
      const [selectedHour, setSelectedHour] = useState(null);
      const [showScrying, setShowScrying] = useState(false);
      const [currentTime, setCurrentTime] = useState(new Date());
      const [aiGuidance, setAiGuidance] = useState(null);
      const [loadingAI, setLoadingAI] = useState(false);
      const [useManualCoords, setUseManualCoords] = useState(false);

      const dayRuler = DAY_RULERS[currentTime.getDay()];
      const dayColors = DAY_COLORS[dayRuler];

      useEffect(() => {
        calculateHours();
        const interval = setInterval(() => {
          setCurrentTime(new Date());
          calculateHours();
        }, 60000);
        return () => clearInterval(interval);
      }, [location, natalChart]);

      useEffect(() => {
        const interval = setInterval(() => {
          setCurrentTime(new Date());
          if (hours.length > 0) {
            const now = new Date();
            const current = hours.find(h => now >= h.start && now < h.end);
            setCurrentHour(current);
          }
        }, 1000);
        return () => clearInterval(interval);
      }, [hours]);

      useEffect(() => {
        if (birthData?.date && birthData?.time) {
          try {
            const birthDateTime = new Date(`${birthData.date}T${birthData.time}`);
            const positions = getAllPlanetPositions(birthDateTime);
            const chart = Object.keys(positions).map(planet => ({
              planet,
              longitude: positions[planet],
              zodiac: getZodiacFromLongitude(positions[planet])
            }));
            setNatalChart(chart);
          } catch (error) {
            console.error('Natal chart error:', error);
          }
        }
      }, [birthData]);

      function calculateHours() {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const ruler = DAY_RULERS[today.getDay()];
        
        try {
          const sunTimes = getSunTimes(today, location.lat, location.lon);
          const planetaryHours = generatePlanetaryHours(ruler, sunTimes.sunrise, sunTimes.sunset, natalChart);
          
          setHours(planetaryHours);
          const current = planetaryHours.find(h => now >= h.start && now < h.end);
          setCurrentHour(current);
        } catch (error) {
          console.error('Hours calculation error:', error);
        }
      }

      async function updateLocation(input) {
        if (!input?.trim()) return;
        
        // Input sanitization - prevent injection attacks
        const sanitized = input.trim().slice(0, 200); // Max 200 chars
        const query = sanitized.includes(',') ? sanitized : `${sanitized}, USA`;
        
        try {
          // Rate limiting - prevent abuse
          const lastRequest = sessionStorage.getItem('lastGeoRequest');
          const now = Date.now();
          if (lastRequest && now - parseInt(lastRequest) < 2000) {
            alert('Please wait a moment before searching again');
            return;
          }
          sessionStorage.setItem('lastGeoRequest', now.toString());
          
          // Timeout protection
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);
          
          // SECURITY: Using OpenStreetMap Nominatim (open source, privacy-respecting)
          // NO tracking, NO data collection, NO API keys required
          const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`,
            { 
              headers: { 
                "User-Agent": "PlanetaryHoursApp/6.0" // Required by Nominatim
              },
              signal: controller.signal
            }
          );
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error('Geocoding service unavailable');
          }
          
          const data = await response.json();
          
          // Validate response data
          if (Array.isArray(data) && data.length > 0 && data[0].lat && data[0].lon) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            
            // Validate coordinate ranges
            if (lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
              setLocation({
                lat,
                lon,
                city: data[0].display_name || sanitized
              });
            } else {
              alert('Invalid coordinates received');
            }
          } else {
            alert('Location not found');
          }
        } catch (error) {
          if (error.name === 'AbortError') {
            alert('Request timeout - try manual coordinates');
          } else {
            alert('Connection error - use manual coordinates for offline mode');
          }
          console.error('Geocoding error:', error);
        }
      }

      function updateManualCoords(lat, lon) {
        // Input validation and sanitization
        const latNum = parseFloat(lat);
        const lonNum = parseFloat(lon);
        
        // Strict validation
        if (isNaN(latNum) || isNaN(lonNum)) {
          alert('Invalid coordinates - must be numbers');
          return;
        }
        
        if (latNum < -90 || latNum > 90) {
          alert('Latitude must be between -90 and 90');
          return;
        }
        
        if (lonNum < -180 || lonNum > 180) {
          alert('Longitude must be between -180 and 180');
          return;
        }
        
        // Safe to use validated coordinates
        setLocation({
          lat: latNum,
          lon: lonNum,
          city: `Manual: ${latNum.toFixed(4)}, ${lonNum.toFixed(4)}`
        });
      }

      async function loadAIGuidance(hour) {
        setLoadingAI(true);
        const guidance = await getAIRitualGuidance(hour, natalChart);
        setAiGuidance(guidance);
        setLoadingAI(false);
      }

      const formatTime = (date) => date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      
      const getTimeRemaining = (endTime) => {
        const diff = endTime - new Date();
        if (diff < 0) return "Ended";
        const mins = Math.floor(diff / 60000);
        const hours = Math.floor(mins / 60);
        return `${hours}h ${mins % 60}m`;
      };

      return (
        <div style={{ 
          minHeight: '100vh', 
          background: `linear-gradient(135deg, ${dayColors.bg} 0%, ${dayColors.bg}dd 100%)`,
          color: '#f0e6d2',
          transition: 'background 1s'
        }}>
          {showScrying && (
            <ScryingScreen 
              onExit={() => setShowScrying(false)}
              planetColor={currentHour?.planet.color || dayColors.primary}
            />
          )}

          <div style={{
            background: `linear-gradient(180deg, ${dayColors.bg}f0 0%, ${dayColors.bg}cc 100%)`,
            backdropFilter: 'blur(10px)',
            borderBottom: `2px solid ${dayColors.primary}`,
            padding: '1.5rem 0',
            position: 'sticky',
            top: 0,
            zIndex: 100
          }}>
            <div style={{ maxWidth: 1200, margin: '0 auto', padding: '0 1rem' }}>
              <h1 style={{ 
                textAlign: 'center',
                fontSize: '2.5rem',
                color: dayColors.primary,
                textShadow: `0 0 20px ${dayColors.primary}80`,
                marginBottom: '0.5rem'
              }}>
                ‚≠ê PLANETARY HOURS ‚≠ê
              </h1>
              
              <div style={{ textAlign: 'center', color: '#b8a080', marginBottom: '1rem' }}>
                {currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
              </div>

              {currentHour && (
                <div style={{
                  background: `linear-gradient(135deg, ${dayColors.primary}33 0%, ${dayColors.secondary}33 100%)`,
                  border: `2px solid ${currentHour.tier.color}`,
                  borderRadius: 12,
                  padding: '1rem',
                  textAlign: 'center',
                  marginBottom: '1rem',
                  boxShadow: `0 0 30px ${currentHour.tier.color}40`
                }}>
                  <div style={{ fontSize: '2rem', color: currentHour.planet.color, marginBottom: '0.5rem' }}>
                    {currentHour.planet.symbol} {currentHour.planet.name}
                  </div>
                  <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>
                    {currentHour.zodiac.symbol} {currentHour.zodiac.name}
                  </div>
                  <div style={{ 
                    display: 'inline-block',
                    background: currentHour.tier.color,
                    color: '#000',
                    padding: '0.5rem 1.5rem',
                    borderRadius: 20,
                    fontSize: '1.2rem',
                    fontWeight: 'bold',
                    marginBottom: '0.5rem'
                  }}>
                    TIER {currentHour.tier.tier} - {currentHour.tier.label} ({currentHour.power}%)
                  </div>
                  <div style={{ fontSize: '0.9rem', color: '#e0d0b0' }}>
                    {formatTime(currentHour.start)} - {formatTime(currentHour.end)} ‚Ä¢ {getTimeRemaining(currentHour.end)} remaining
                  </div>
                  <div style={{ fontSize: '0.85rem', color: '#c0b090', marginTop: '0.5rem' }}>
                    {currentHour.tier.desc}
                  </div>
                </div>
              )}

              <div style={{ textAlign: 'center', color: '#b8a080', fontSize: '0.9rem' }}>
                Day Ruler: {PLANET_DETAILS[dayRuler].symbol} {dayRuler} ‚Ä¢ {location.city}
              </div>
            </div>
          </div>

          <div style={{ maxWidth: 1200, margin: '0 auto', padding: '0 1rem' }}>
            <div style={{ display: 'flex', gap: '0.5rem', padding: '1rem 0', overflowX: 'auto', justifyContent: 'center', flexWrap: 'wrap' }}>
              {[
                { id: 'hours', label: 'All Hours' },
                { id: 'optimal', label: 'Best Hours' },
                { id: 'natal', label: 'Natal' },
                { id: 'info', label: 'Correspondences' },
                { id: 'settings', label: 'Settings' }
              ].map(view => (
                <button
                  key={view.id}
                  onClick={() => setActiveView(view.id)}
                  style={{
                    background: activeView === view.id 
                      ? `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`
                      : `${dayColors.bg}dd`,
                    color: activeView === view.id ? dayColors.bg : dayColors.primary,
                    border: `1px solid ${dayColors.primary}`,
                    padding: '0.75rem 1.5rem',
                    borderRadius: 8,
                    cursor: 'pointer',
                    fontSize: '0.9rem',
                    fontWeight: activeView === view.id ? 'bold' : 'normal',
                    transition: 'all 0.3s',
                    boxShadow: activeView === view.id ? `0 0 20px ${dayColors.primary}60` : 'none'
                  }}
                >
                  {view.label}
                </button>
              ))}
            </div>

            <div style={{ paddingBottom: '2rem' }}>
              {activeView === 'hours' && <HoursView hours={hours} currentHour={currentHour} dayColors={dayColors} onSelectHour={(h) => { setSelectedHour(h); loadAIGuidance(h); }} formatTime={formatTime} getTimeRemaining={getTimeRemaining} />}
              {activeView === 'optimal' && <OptimalView hours={hours} dayColors={dayColors} onSelectHour={(h) => { setSelectedHour(h); loadAIGuidance(h); }} formatTime={formatTime} />}
              {activeView === 'natal' && <NatalView natalChart={natalChart} birthData={birthData} dayColors={dayColors} onNavigateToSettings={() => setActiveView('settings')} />}
              {activeView === 'info' && <CorrespondencesView dayColors={dayColors} />}
              {activeView === 'settings' && <SettingsView location={location} birthData={birthData} dayColors={dayColors} onUpdateLocation={updateLocation} onUpdateManualCoords={updateManualCoords} onUpdateBirthData={setBirthData} useManualCoords={useManualCoords} onToggleManual={setUseManualCoords} />}
            </div>
          </div>

          {selectedHour && (
            <HourDetailModal 
              hour={selectedHour}
              dayColors={dayColors}
              onClose={() => { setSelectedHour(null); setAiGuidance(null); }}
              onStartScrying={() => setShowScrying(true)}
              formatTime={formatTime}
              aiGuidance={aiGuidance}
              loadingAI={loadingAI}
            />
          )}
        </div>
      );
    }

    function HoursView({ hours, currentHour, dayColors, onSelectHour, formatTime, getTimeRemaining }) {
      return (
        <div>
          <h2 style={{ textAlign: 'center', color: dayColors.primary, fontSize: '1.8rem', marginBottom: '1rem' }}>
            24 Planetary Hours
          </h2>
          <div style={{ display: 'grid', gap: '1rem' }}>
            {hours.map((h, idx) => {
              const isActive = currentHour && h.start.getTime() === currentHour.start.getTime();
              return (
                <div
                  key={idx}
                  onClick={() => onSelectHour(h)}
                  style={{
                    background: isActive 
                      ? `linear-gradient(135deg, ${h.tier.color}40 0%, ${h.tier.color}20 100%)`
                      : `${dayColors.bg}99`,
                    border: `2px solid ${isActive ? h.tier.color : '#3a2a5a'}`,
                    borderLeftWidth: 6,
                    borderLeftColor: h.planet.color,
                    borderRadius: 12,
                    padding: '1.25rem',
                    cursor: 'pointer',
                    transition: 'all 0.3s',
                    boxShadow: isActive ? `0 0 20px ${h.tier.color}40` : 'none'
                  }}
                >
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.75rem' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                      <div style={{ fontSize: '2.5rem', color: h.planet.color }}>{h.planet.symbol}</div>
                      <div>
                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: h.planet.color }}>{h.planet.name}</div>
                        <div style={{ color: '#b8a080', fontSize: '0.9rem' }}>{formatTime(h.start)} - {formatTime(h.end)}</div>
                      </div>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontSize: '2rem' }}>{h.zodiac.symbol}</div>
                      <div style={{ fontSize: '0.9rem', color: '#e0d0b0' }}>{h.zodiac.name}</div>
                    </div>
                  </div>
                  <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap' }}>
                    <div style={{
                      background: h.tier.color,
                      color: '#000',
                      padding: '0.4rem 1rem',
                      borderRadius: 12,
                      fontSize: '0.85rem',
                      fontWeight: 'bold'
                    }}>
                      TIER {h.tier.tier} ({h.power}%)
                    </div>
                    <div style={{ fontSize: '0.85rem', color: '#c0b090' }}>
                      {h.dignity} ‚Ä¢ {h.isDayHour ? 'Day' : 'Night'}
                    </div>
                  </div>
                  {isActive && (
                    <div style={{
                      background: dayColors.primary,
                      color: dayColors.bg,
                      padding: '0.5rem 1rem',
                      borderRadius: 12,
                      fontSize: '0.85rem',
                      fontWeight: 'bold',
                      display: 'inline-block',
                      marginTop: '0.75rem'
                    }}>
                      ACTIVE NOW ‚Ä¢ {getTimeRemaining(h.end)}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function OptimalView({ hours, dayColors, onSelectHour, formatTime }) {
      const optimal = hours.filter(h => h.power >= 60).sort((a, b) => b.power - a.power);
      
      return (
        <div>
          <h2 style={{ textAlign: 'center', color: dayColors.primary, fontSize: '1.8rem', marginBottom: '0.5rem' }}>
            Optimal Hours for Ritual Work
          </h2>
          <p style={{ textAlign: 'center', color: '#b8a080', marginBottom: '1.5rem', fontSize: '0.95rem' }}>
            {optimal.length} hours with power ‚â•60% (Tier B or better)
          </p>
          
          {optimal.length === 0 && (
            <div style={{ textAlign: 'center', padding: '3rem', color: '#b8a080' }}>
              <p style={{ fontSize: '1.2rem', marginBottom: '1rem' }}>No optimal hours found today</p>
              <p>Consider checking natal resonance or working with lower-tier hours</p>
            </div>
          )}
          
          <div style={{ display: 'grid', gap: '1rem' }}>
            {optimal.map((h, idx) => (
              <div
                key={idx}
                onClick={() => onSelectHour(h)}
                style={{
                  background: `linear-gradient(135deg, ${h.tier.color}30 0%, ${h.tier.color}15 100%)`,
                  border: `2px solid ${h.tier.color}`,
                  borderLeftWidth: 6,
                  borderLeftColor: h.planet.color,
                  borderRadius: 12,
                  padding: '1.25rem',
                  cursor: 'pointer',
                  transition: 'all 0.3s',
                  boxShadow: `0 0 15px ${h.tier.color}30`
                }}
              >
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem' }}>
                  <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                    <div style={{ fontSize: '2.5rem', color: h.planet.color }}>{h.planet.symbol}</div>
                    <div>
                      <div style={{ fontSize: '1.5rem', color: h.planet.color, fontWeight: 'bold' }}>{h.planet.name}</div>
                      <div style={{ fontSize: '0.9rem', color: '#b8a080' }}>{formatTime(h.start)} - {formatTime(h.end)}</div>
                    </div>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <div style={{ 
                      background: h.tier.color,
                      color: '#000',
                      padding: '0.5rem 1.2rem',
                      borderRadius: 20,
                      fontSize: '1.1rem',
                      fontWeight: 'bold',
                      marginBottom: '0.5rem'
                    }}>
                      TIER {h.tier.tier}
                    </div>
                    <div style={{ fontSize: '1rem', color: '#e0d0b0' }}>{h.power}% Power</div>
                  </div>
                </div>
                <div style={{ display: 'flex', gap: '1rem', fontSize: '0.9rem', color: '#c0b090' }}>
                  <span>{h.zodiac.symbol} {h.zodiac.name}</span>
                  <span>‚Ä¢</span>
                  <span>{h.dignity}</span>
                  <span>‚Ä¢</span>
                  <span>{h.isDayHour ? 'Day' : 'Night'} Hour</span>
                </div>
                <div style={{ marginTop: '0.75rem', fontSize: '0.85rem', color: '#e0d0b0' }}>
                  {h.tier.desc}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function NatalView({ natalChart, birthData, dayColors, onNavigateToSettings }) {
      if (!natalChart) {
        return (
          <div style={{ textAlign: 'center', padding: '3rem' }}>
            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üìÖ</div>
            <p style={{ fontSize: '1.2rem', marginBottom: '1rem', color: '#e0d0b0' }}>No birth data configured</p>
            <p style={{ color: '#b8a080', marginBottom: '2rem' }}>
              Add your birth date and time to see natal planetary positions and resonance with current hours
            </p>
            <button onClick={onNavigateToSettings} style={{
              background: `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
              color: dayColors.bg,
              border: 'none',
              padding: '1rem 2rem',
              borderRadius: 8,
              cursor: 'pointer',
              fontSize: '1rem',
              fontWeight: 'bold'
            }}>
              Configure Birth Data
            </button>
          </div>
        );
      }

      return (
        <div>
          <h2 style={{ textAlign: 'center', color: dayColors.primary, fontSize: '1.8rem', marginBottom: '0.5rem' }}>
            Your Natal Chart
          </h2>
          {birthData?.date && (
            <p style={{ textAlign: 'center', color: '#b8a080', marginBottom: '1.5rem' }}>
              Born: {new Date(birthData.date + 'T' + birthData.time).toLocaleString()}
            </p>
          )}
          <div style={{ display: 'grid', gap: '1rem' }}>
            {natalChart.map((item, idx) => (
              <div key={idx} style={{
                background: `${dayColors.bg}99`,
                border: `2px solid #3a2a5a`,
                borderLeftWidth: 6,
                borderLeftColor: PLANET_DETAILS[item.planet].color,
                borderRadius: 12,
                padding: '1.25rem'
              }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                    <div style={{ fontSize: '2.5rem', color: PLANET_DETAILS[item.planet].color }}>
                      {PLANET_DETAILS[item.planet].symbol}
                    </div>
                    <div>
                      <div style={{ fontSize: '1.5rem', color: PLANET_DETAILS[item.planet].color, fontWeight: 'bold' }}>
                        {item.planet}
                      </div>
                      <div style={{ fontSize: '0.9rem', color: '#b8a080' }}>
                        {item.longitude.toFixed(2)}¬∞ ‚Ä¢ {getDignity(item.planet, item.zodiac.name)}
                      </div>
                    </div>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <div style={{ fontSize: '2.5rem' }}>{item.zodiac.symbol}</div>
                    <div style={{ fontSize: '1.2rem', color: '#e0d0b0' }}>{item.zodiac.name}</div>
                    <div style={{ fontSize: '0.8rem', color: '#b8a080' }}>{item.zodiac.element}</div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function CorrespondencesView({ dayColors }) {
      const [expanded, setExpanded] = useState(null);
      
      return (
        <div>
          <h2 style={{ textAlign: 'center', color: dayColors.primary, fontSize: '1.8rem', marginBottom: '1rem' }}>
            Planetary Correspondences
          </h2>
          <div style={{ display: 'grid', gap: '1rem' }}>
            {Object.entries(CORRESPONDENCES).map(([planet, data]) => (
              <div key={planet}>
                <div onClick={() => setExpanded(expanded === planet ? null : planet)} style={{
                  background: `${dayColors.bg}99`,
                  border: `2px solid ${expanded === planet ? dayColors.primary : '#3a2a5a'}`,
                  borderLeftWidth: 6,
                  borderLeftColor: PLANET_DETAILS[planet].color,
                  borderRadius: expanded === planet ? '12px 12px 0 0' : 12,
                  padding: '1rem',
                  cursor: 'pointer',
                  transition: 'all 0.3s'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                      <span style={{ fontSize: '2rem', color: PLANET_DETAILS[planet].color }}>
                        {PLANET_DETAILS[planet].symbol}
                      </span>
                      <div>
                        <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: PLANET_DETAILS[planet].color }}>
                          {planet}
                        </div>
                        <div style={{ fontSize: '0.85rem', color: '#b8a080' }}>
                          {data.metal}
                        </div>
                      </div>
                    </div>
                    <div style={{ fontSize: '0.9rem', color: '#b8a080', textAlign: 'right' }}>
                      {data.suitable.split(',')[0]}
                      <div style={{ fontSize: '1.5rem', marginTop: '0.25rem' }}>
                        {expanded === planet ? '‚ñº' : '‚ñ∂'}
                      </div>
                    </div>
                  </div>
                </div>
                
                {expanded === planet && (
                  <div style={{
                    background: `${dayColors.primary}20`,
                    border: `2px solid ${dayColors.primary}`,
                    borderTop: 'none',
                    borderRadius: '0 0 12px 12px',
                    padding: '1.5rem'
                  }}>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem' }}>
                      <div>
                        <h4 style={{ color: dayColors.primary, marginBottom: '0.75rem', fontSize: '1.1rem' }}>Sacred Names</h4>
                        <p style={{ fontSize: '0.9rem', marginBottom: '0.5rem' }}><strong>Archangel:</strong> {data.archangel}</p>
                        <p style={{ fontSize: '0.9rem', marginBottom: '0.5rem' }}><strong>Intelligence:</strong> {data.intelligence}</p>
                        <p style={{ fontSize: '0.9rem' }}><strong>Spirit:</strong> {data.spirit}</p>
                      </div>
                      <div>
                        <h4 style={{ color: dayColors.primary, marginBottom: '0.75rem', fontSize: '1.1rem' }}>Materials</h4>
                        <p style={{ fontSize: '0.9rem', marginBottom: '0.5rem' }}><strong>Metal:</strong> {data.metal}</p>
                        <p style={{ fontSize: '0.9rem', marginBottom: '0.5rem' }}><strong>Incense:</strong> {data.incense}</p>
                        <p style={{ fontSize: '0.9rem' }}><strong>Crystals:</strong> {data.crystals}</p>
                      </div>
                    </div>
                    <div style={{ marginTop: '1rem' }}>
                      <h4 style={{ color: dayColors.primary, marginBottom: '0.75rem', fontSize: '1.1rem' }}>Traditional Operations</h4>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                        {data.operations.map((op, i) => (
                          <span key={i} style={{
                            background: `${PLANET_DETAILS[planet].color}30`,
                            border: `1px solid ${PLANET_DETAILS[planet].color}`,
                            padding: '0.4rem 0.8rem',
                            borderRadius: 8,
                            fontSize: '0.85rem'
                          }}>
                            {op}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    function SettingsView({ location, birthData, dayColors, onUpdateLocation, onUpdateManualCoords, onUpdateBirthData, useManualCoords, onToggleManual }) {
      const [locationInput, setLocationInput] = useState(location.city);
      const [latInput, setLatInput] = useState(location.lat.toString());
      const [lonInput, setLonInput] = useState(location.lon.toString());
      const [birthDate, setBirthDate] = useState(birthData?.date || '');
      const [birthTime, setBirthTime] = useState(birthData?.time || '');
      const [birthLocation, setBirthLocation] = useState(birthData?.location || '');

      return (
        <div style={{ maxWidth: 600, margin: '0 auto' }}>
          <div style={{
            background: `${dayColors.bg}99`,
            border: '1px solid #3a2a5a',
            borderRadius: 12,
            padding: '1.5rem',
            marginBottom: '1.5rem'
          }}>
            <h3 style={{ color: dayColors.primary, marginBottom: '1rem' }}>Location Settings</h3>
            
            <div style={{ marginBottom: '1rem' }}>
              <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer', marginBottom: '1rem' }}>
                <input
                  type="checkbox"
                  checked={useManualCoords}
                  onChange={(e) => onToggleManual(e.target.checked)}
                  style={{ width: '1.2rem', height: '1.2rem', cursor: 'pointer' }}
                />
                <span style={{ fontSize: '0.95rem' }}>Use manual coordinates (works offline)</span>
              </label>
            </div>
            
            {!useManualCoords ? (
              <>
                <input
                  type="text"
                  value={locationInput}
                  onChange={(e) => setLocationInput(e.target.value)}
                  placeholder="City, State, Country"
                  style={{
                    width: '100%',
                    background: `${dayColors.bg}cc`,
                    border: '1px solid #3a2a5a',
                    borderRadius: 8,
                    padding: '0.75rem',
                    color: '#f0e6d2',
                    fontSize: '1rem',
                    marginBottom: '1rem'
                  }}
                />
                <button
                  onClick={() => onUpdateLocation(locationInput)}
                  style={{
                    width: '100%',
                    background: `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
                    color: dayColors.bg,
                    border: 'none',
                    padding: '1rem',
                    borderRadius: 8,
                    fontSize: '1rem',
                    fontWeight: 'bold',
                    cursor: 'pointer'
                  }}
                >
                  Update Location
                </button>
              </>
            ) : (
              <>
                <div style={{ marginBottom: '1rem' }}>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.9rem', color: '#b8a080' }}>
                    Latitude (-90 to 90)
                  </label>
                  <input
                    type="number"
                    step="0.0001"
                    value={latInput}
                    onChange={(e) => setLatInput(e.target.value)}
                    placeholder="40.7128"
                    style={{
                      width: '100%',
                      background: `${dayColors.bg}cc`,
                      border: '1px solid #3a2a5a',
                      borderRadius: 8,
                      padding: '0.75rem',
                      color: '#f0e6d2',
                      fontSize: '1rem'
                    }}
                  />
                </div>
                <div style={{ marginBottom: '1rem' }}>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.9rem', color: '#b8a080' }}>
                    Longitude (-180 to 180)
                  </label>
                  <input
                    type="number"
                    step="0.0001"
                    value={lonInput}
                    onChange={(e) => setLonInput(e.target.value)}
                    placeholder="-74.0060"
                    style={{
                      width: '100%',
                      background: `${dayColors.bg}cc`,
                      border: '1px solid #3a2a5a',
                      borderRadius: 8,
                      padding: '0.75rem',
                      color: '#f0e6d2',
                      fontSize: '1rem'
                    }}
                  />
                </div>
                <button
                  onClick={() => onUpdateManualCoords(latInput, lonInput)}
                  style={{
                    width: '100%',
                    background: `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
                    color: dayColors.bg,
                    border: 'none',
                    padding: '1rem',
                    borderRadius: 8,
                    fontSize: '1rem',
                    fontWeight: 'bold',
                    cursor: 'pointer'
                  }}
                >
                  Set Coordinates
                </button>
              </>
            )}
            
            <div style={{ marginTop: '1rem', padding: '0.75rem', background: `${dayColors.primary}20`, borderRadius: 8, fontSize: '0.85rem', color: '#e0d0b0' }}>
              Current: {location.lat.toFixed(4)}, {location.lon.toFixed(4)}
            </div>
          </div>

          <div style={{
            background: `${dayColors.bg}99`,
            border: '1px solid #3a2a5a',
            borderRadius: 12,
            padding: '1.5rem'
          }}>
            <h3 style={{ color: dayColors.primary, marginBottom: '1rem' }}>Birth Data (Optional)</h3>
            <p style={{ fontSize: '0.85rem', color: '#b8a080', marginBottom: '1rem' }}>
              Add birth data to see natal resonance and personalized power calculations
            </p>
            <input
              type="date"
              value={birthDate}
              onChange={(e) => setBirthDate(e.target.value)}
              style={{
                width: '100%',
                background: `${dayColors.bg}cc`,
                border: '1px solid #3a2a5a',
                borderRadius: 8,
                padding: '0.75rem',
                color: '#f0e6d2',
                fontSize: '1rem',
                marginBottom: '1rem'
              }}
            />
            <input
              type="time"
              value={birthTime}
              onChange={(e) => setBirthTime(e.target.value)}
              style={{
                width: '100%',
                background: `${dayColors.bg}cc`,
                border: '1px solid #3a2a5a',
                borderRadius: 8,
                padding: '0.75rem',
                color: '#f0e6d2',
                fontSize: '1rem',
                marginBottom: '1rem'
              }}
            />
            <input
              type="text"
              value={birthLocation}
              onChange={(e) => setBirthLocation(e.target.value)}
              placeholder="Birth Location (optional)"
              style={{
                width: '100%',
                background: `${dayColors.bg}cc`,
                border: '1px solid #3a2a5a',
                borderRadius: 8,
                padding: '0.75rem',
                color: '#f0e6d2',
                fontSize: '1rem',
                marginBottom: '1rem'
              }}
            />
            <button
              onClick={() => {
                if (birthDate && birthTime) {
                  onUpdateBirthData({ date: birthDate, time: birthTime, location: birthLocation });
                  alert('Birth data saved! Natal resonance will now affect power calculations.');
                } else {
                  alert('Please enter both date and time');
                }
              }}
              style={{
                width: '100%',
                background: `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
                color: dayColors.bg,
                border: 'none',
                padding: '1rem',
                borderRadius: 8,
                fontSize: '1rem',
                fontWeight: 'bold',
                cursor: 'pointer'
              }}
            >
              Save Birth Data
            </button>
          </div>
        </div>
      );
    }

    function HourDetailModal({ hour, dayColors, onClose, onStartScrying, formatTime, aiGuidance, loadingAI }) {
      const corr = CORRESPONDENCES[hour.planet.name];

      return (
        <div 
          style={{ 
            position: 'fixed', 
            top: 0, 
            left: 0, 
            width: '100%', 
            height: '100%', 
            background: 'rgba(0,0,0,0.95)', 
            zIndex: 2000,
            overflowY: 'auto',
            padding: '2rem'
          }}
          onClick={onClose}
        >
          <div 
            style={{
              maxWidth: 800,
              margin: '0 auto',
              background: `linear-gradient(135deg, ${dayColors.bg}f5 0%, ${dayColors.bg}dd 100%)`,
              border: `3px solid ${hour.tier.color}`,
              borderRadius: 16,
              padding: '2rem',
              boxShadow: `0 0 40px ${hour.tier.color}60`
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <button
              onClick={onClose}
              style={{
                background: '#8b5cf6',
                color: 'white',
                border: 'none',
                padding: '0.75rem 1.5rem',
                borderRadius: 8,
                cursor: 'pointer',
                fontSize: '1rem',
                marginBottom: '1rem',
                fontWeight: 'bold'
              }}
            >
              ‚Üê Back
            </button>

            <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
              <div style={{ fontSize: '6rem', color: hour.planet.color, marginBottom: '1rem' }}>
                {hour.planet.symbol}
              </div>
              <h2 style={{ fontSize: '2.5rem', color: hour.planet.color, margin: '0.5rem 0' }}>
                Hour of {hour.planet.name}
              </h2>
              <div style={{ fontSize: '1.5rem', marginBottom: '1rem' }}>
                {hour.zodiac.symbol} {hour.zodiac.name}
              </div>
              <div style={{ 
                display: 'inline-block',
                background: hour.tier.color,
                color: '#000',
                padding: '0.75rem 2rem',
                borderRadius: 20,
                fontSize: '1.5rem',
                fontWeight: 'bold',
                marginBottom: '1rem'
              }}>
                TIER {hour.tier.tier} - {hour.tier.label}
              </div>
              <div style={{ fontSize: '1.2rem', color: '#e0d0b0', marginBottom: '0.5rem' }}>
                {formatTime(hour.start)} - {formatTime(hour.end)}
              </div>
              <div style={{ fontSize: '1rem', color: '#b8a080' }}>
                Ritual Power: {hour.power}% ‚Ä¢ {hour.dignity} ‚Ä¢ {hour.isDayHour ? 'Day' : 'Night'} Hour
              </div>
              <div style={{ fontSize: '0.95rem', color: '#c0b090', marginTop: '0.5rem', fontStyle: 'italic' }}>
                {hour.tier.desc}
              </div>
            </div>

            <div style={{ background: 'rgba(0,0,0,0.4)', padding: '1.5rem', borderRadius: 12, marginBottom: '1.5rem' }}>
              <h3 style={{ color: dayColors.primary, marginBottom: '1rem', fontSize: '1.3rem' }}>Planetary Correspondences</h3>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', fontSize: '0.95rem' }}>
                <div>
                  <p style={{ marginBottom: '0.5rem' }}><strong>Archangel:</strong> {corr.archangel}</p>
                  <p style={{ marginBottom: '0.5rem' }}><strong>Intelligence:</strong> {corr.intelligence}</p>
                  <p><strong>Spirit:</strong> {corr.spirit}</p>
                </div>
                <div>
                  <p style={{ marginBottom: '0.5rem' }}><strong>Metal:</strong> {corr.metal}</p>
                  <p style={{ marginBottom: '0.5rem' }}><strong>Incense:</strong> {corr.incense}</p>
                  <p><strong>Crystals:</strong> {corr.crystals}</p>
                </div>
              </div>
              <div style={{ marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid #3a2a5a' }}>
                <p><strong>Suitable For:</strong> {corr.suitable}</p>
              </div>
            </div>

            {loadingAI && (
              <div style={{ textAlign: 'center', padding: '2rem', background: 'rgba(0,0,0,0.4)', borderRadius: 12, marginBottom: '1.5rem' }}>
                <div style={{ fontSize: '1.2rem', color: dayColors.primary, marginBottom: '0.5rem' }}>
                  ‚ú® Generating AI Ritual Guidance...
                </div>
                <div style={{ fontSize: '0.9rem', color: '#b8a080' }}>
                  Analyzing planetary conditions
                </div>
              </div>
            )}

            {aiGuidance && !loadingAI && (
              <div style={{ background: `${dayColors.primary}20`, padding: '1.5rem', borderRadius: 12, marginBottom: '1.5rem', border: `1px solid ${dayColors.primary}` }}>
                <h3 style={{ color: dayColors.primary, marginBottom: '1rem', fontSize: '1.3rem' }}>
                  ü§ñ AI Ritual Recommendations
                </h3>
                {aiGuidance.suggestions?.map((sug, i) => (
                  <div key={i} style={{ 
                    background: 'rgba(0,0,0,0.3)', 
                    padding: '1rem', 
                    borderRadius: 8, 
                    marginBottom: i < aiGuidance.suggestions.length - 1 ? '1rem' : 0,
                    borderLeft: `4px solid ${hour.planet.color}`
                  }}>
                    <h4 style={{ color: hour.planet.color, marginBottom: '0.5rem', fontSize: '1.1rem' }}>
                      {i + 1}. {sug.title}
                    </h4>
                    <p style={{ marginBottom: '0.75rem', fontSize: '0.95rem', lineHeight: '1.5' }}>
                      {sug.description}
                    </p>
                    <div style={{ fontSize: '0.85rem', color: '#b8a080' }}>
                      <p style={{ marginBottom: '0.25rem' }}><strong>Materials:</strong> {sug.materials}</p>
                      {sug.timing && <p><strong>Timing:</strong> {sug.timing}</p>}
                    </div>
                  </div>
                ))}
              </div>
            )}

            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap', justifyContent: 'center' }}>
              <button
                onClick={onStartScrying}
                style={{
                  background: `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
                  color: dayColors.bg,
                  border: 'none',
                  padding: '1rem 2rem',
                  borderRadius: 8,
                  fontSize: '1.1rem',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  boxShadow: `0 4px 20px ${dayColors.primary}40`
                }}
              >
                üëÅÔ∏è Begin Scrying
              </button>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<PlanetaryHoursApp />);
  </script>
</body>
</html>
