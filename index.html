import React, { useState, useEffect, useRef } from 'react';
import { Clock, Calendar, Book, Settings, Eye, Star, MapPin, Download, AlertCircle } from 'lucide-react';

// ASTRONOMICAL CALCULATIONS
const RAD = Math.PI / 180;
const J1970 = 2440587.5;
const J2000 = 2451545.0;

const toJulian = (date) => date.valueOf() / 86400000 - 0.5 + J1970;
const fromJulian = (j) => new Date((j + 0.5 - J1970) * 86400000);
const normalize = (deg) => (deg % 360 + 360) % 360;

function getSunTimes(date, lat, lon) {
  const phi = RAD * lat;
  const lw = RAD * -lon;
  const d = toJulian(date) - J2000;
  const M = RAD * (357.5291 + 0.98560028 * d);
  const C = RAD * (1.9148 * Math.sin(M) + 0.0200 * Math.sin(2 * M));
  const P = RAD * 102.9372;
  const L = M + C + P + Math.PI;
  const dec = Math.asin(Math.sin(L) * Math.sin(RAD * 23.44));
  const H = Math.acos((Math.sin(RAD * -0.83) - Math.sin(phi) * Math.sin(dec)) / (Math.cos(phi) * Math.cos(dec)));
  const Jtransit = J2000 + d + lw / (2 * Math.PI);
  
  return {
    sunrise: fromJulian(Jtransit - H / (2 * Math.PI)),
    sunset: fromJulian(Jtransit + H / (2 * Math.PI))
  };
}

function planetLongitudes(date) {
  const d = toJulian(date) - 2451545.0;
  const sunL0 = normalize(280.46646 + 0.9856474 * d);
  const sunM = normalize(357.52911 + 0.9856003 * d);
  const sunC = 1.914602 * Math.sin(sunM * RAD);
  const moonL0 = normalize(218.316 + 13.176396 * d);
  const moonM = normalize(134.963 + 13.064993 * d);
  
  return {
    Sun: normalize(sunL0 + sunC),
    Moon: normalize(moonL0 + 6.289 * Math.sin(moonM * RAD)),
    Mercury: normalize(252.250 + 4.09233445 * d),
    Venus: normalize(181.979 + 1.60213034 * d),
    Mars: normalize(355.433 + 0.52403840 * d),
    Jupiter: normalize(34.351 + 0.08308677 * d),
    Saturn: normalize(50.077 + 0.03344414 * d)
  };
}

const CHALDEAN_ORDER = ["Saturn", "Jupiter", "Mars", "Sun", "Venus", "Mercury", "Moon"];
const DAY_RULERS = ["Sun", "Moon", "Mars", "Mercury", "Jupiter", "Venus", "Saturn"];

const DAY_COLORS = {
  Sun: { bg: '#1a0a00', primary: '#FFD700', secondary: '#FFA500' },
  Moon: { bg: '#0a0a1a', primary: '#C0C0C0', secondary: '#E8E8E8' },
  Mars: { bg: '#1a0000', primary: '#FF4500', secondary: '#DC143C' },
  Mercury: { bg: '#1a0f00', primary: '#FFA500', secondary: '#FFB347' },
  Jupiter: { bg: '#00001a', primary: '#4169E1', secondary: '#1E90FF' },
  Venus: { bg: '#001a0a', primary: '#00FF7F', secondary: '#98FB98' },
  Saturn: { bg: '#000000', primary: '#708090', secondary: '#A9A9A9' }
};

const PLANET_DETAILS = {
  Sun: { symbol: "☉", color: "#FFD700" },
  Moon: { symbol: "☽", color: "#C0C0C0" },
  Mercury: { symbol: "☿", color: "#FFA500" },
  Venus: { symbol: "♀", color: "#00FF7F" },
  Mars: { symbol: "♂", color: "#FF4500" },
  Jupiter: { symbol: "♃", color: "#4169E1" },
  Saturn: { symbol: "♄", color: "#708090" }
};

const ZODIAC_SIGNS = [
  { name: "Aries", symbol: "♈", start: 0 },
  { name: "Taurus", symbol: "♉", start: 30 },
  { name: "Gemini", symbol: "♊", start: 60 },
  { name: "Cancer", symbol: "♋", start: 90 },
  { name: "Leo", symbol: "♌", start: 120 },
  { name: "Virgo", symbol: "♍", start: 150 },
  { name: "Libra", symbol: "♎", start: 180 },
  { name: "Scorpio", symbol: "♏", start: 210 },
  { name: "Sagittarius", symbol: "♐", start: 240 },
  { name: "Capricorn", symbol: "♑", start: 270 },
  { name: "Aquarius", symbol: "♒", start: 300 },
  { name: "Pisces", symbol: "♓", start: 330 }
];

const PLANET_DIGNITIES = {
  Sun: { exaltation: "Aries", detriment: "Aquarius", fall: "Libra" },
  Moon: { exaltation: "Taurus", detriment: "Capricorn", fall: "Scorpio" },
  Mercury: { exaltation: "Virgo", detriment: "Sagittarius", fall: "Pisces" },
  Venus: { exaltation: "Pisces", detriment: "Aries", fall: "Virgo" },
  Mars: { exaltation: "Capricorn", detriment: "Libra", fall: "Cancer" },
  Jupiter: { exaltation: "Cancer", detriment: "Gemini", fall: "Capricorn" },
  Saturn: { exaltation: "Libra", detriment: "Cancer", fall: "Aries" }
};

const CORRESPONDENCES = {
  Saturn: {
    archangel: "Cassiel", intelligence: "Agiel", spirit: "Zazel",
    metal: "Lead", incense: "Myrrh", crystals: "Onyx",
    suitable: "Bindings, discipline", divineNames: "YHVH Elohim"
  },
  Jupiter: {
    archangel: "Zadkiel", intelligence: "Iophiel", spirit: "Hismael",
    metal: "Tin", incense: "Cedar", crystals: "Amethyst",
    suitable: "Wealth, expansion", divineNames: "El"
  },
  Mars: {
    archangel: "Camael", intelligence: "Graphiel", spirit: "Bartzabel",
    metal: "Iron", incense: "Dragon's blood", crystals: "Ruby",
    suitable: "Courage, victory", divineNames: "Elohim Gibor"
  },
  Sun: {
    archangel: "Michael", intelligence: "Nakhiel", spirit: "Sorath",
    metal: "Gold", incense: "Frankincense", crystals: "Citrine",
    suitable: "Success, healing", divineNames: "YHVH Eloah va-Daath"
  },
  Venus: {
    archangel: "Haniel", intelligence: "Hagiel", spirit: "Kedemel",
    metal: "Copper", incense: "Rose", crystals: "Emerald",
    suitable: "Love, beauty", divineNames: "YHVH Tzabaoth"
  },
  Mercury: {
    archangel: "Raphael", intelligence: "Tiriel", spirit: "Taphthartharath",
    metal: "Mercury", incense: "Lavender", crystals: "Agate",
    suitable: "Communication, learning", divineNames: "Elohim Tzabaoth"
  },
  Moon: {
    archangel: "Gabriel", intelligence: "Malkah be-Tarshishim", spirit: "Chasmodai",
    metal: "Silver", incense: "Jasmine", crystals: "Moonstone",
    suitable: "Dreams, intuition", divineNames: "Shaddai El Chai"
  }
};

function sanitizeInput(input) {
  if (typeof input !== 'string') return '';
  return input.trim().replace(/[<>'"]/g, '').substring(0, 200);
}

function getZodiacFromLongitude(deg) {
  const longitude = normalize(deg);
  for (let i = ZODIAC_SIGNS.length - 1; i >= 0; i--) {
    if (longitude >= ZODIAC_SIGNS[i].start) return ZODIAC_SIGNS[i];
  }
  return ZODIAC_SIGNS[0];
}

function getDignity(planet, zodiacName) {
  const dig = PLANET_DIGNITIES[planet];
  if (!dig) return "Neutral";
  if (zodiacName === dig.exaltation) return "Exaltation";
  if (zodiacName === dig.detriment) return "Detriment";
  if (zodiacName === dig.fall) return "Fall";
  return "Neutral";
}

function getHourStrength(planet, zodiacName, natalMatch = false) {
  let score = 1;
  const dignity = getDignity(planet, zodiacName);
  if (dignity === "Exaltation") score += 2;
  if (dignity === "Neutral") score += 1;
  if (dignity === "Detriment") score -= 1;
  if (dignity === "Fall") score -= 2;
  if (natalMatch) score += 1;
  return score;
}

function generatePlanetaryHours(dayRuler, sunrise, sunset) {
  const hours = [];
  const nextSunrise = new Date(sunrise.getTime() + 24 * 60 * 60 * 1000);
  const dayLength = (sunset - sunrise) / 12;
  const nightLength = (nextSunrise - sunset) / 12;
  
  let startIndex = CHALDEAN_ORDER.indexOf(dayRuler);
  if (startIndex === -1) startIndex = 0;

  for (let i = 0; i < 24; i++) {
    const planetIndex = (startIndex + i) % 7;
    const planetName = CHALDEAN_ORDER[planetIndex];
    const planet = PLANET_DETAILS[planetName];
    
    let start, end;
    if (i < 12) {
      start = new Date(sunrise.getTime() + i * dayLength);
      end = new Date(sunrise.getTime() + (i + 1) * dayLength);
    } else {
      start = new Date(sunset.getTime() + (i - 12) * nightLength);
      end = new Date(sunset.getTime() + (i - 11) * nightLength);
    }
    
    const zodiac = getZodiacFromLongitude(planetLongitudes(start)[planetName]);
    const dignity = getDignity(planetName, zodiac.name);
    
    hours.push({ 
      planet: { name: planetName, ...planet },
      start, end, zodiac, dignity,
      isDayHour: i < 12,
      hourNumber: i + 1
    });
  }
  return hours;
}

const rateLimiter = {
  requests: {},
  canMakeRequest(key, max = 10, window = 60000) {
    const now = Date.now();
    if (!this.requests[key]) this.requests[key] = [];
    this.requests[key] = this.requests[key].filter(t => now - t < window);
    if (this.requests[key].length >= max) return false;
    this.requests[key].push(now);
    return true;
  }
};

export default function PlanetaryHoursApp() {
  const [location, setLocation] = useState({ lat: 40.7128, lon: -74.0060, city: "New York, NY, USA" });
  const [hours, setHours] = useState([]);
  const [currentHour, setCurrentHour] = useState(null);
  const [birthData, setBirthData] = useState(null);
  const [natalChart, setNatalChart] = useState(null);
  const [activeView, setActiveView] = useState('hours');
  const [selectedHour, setSelectedHour] = useState(null);
  const [expandedPlanet, setExpandedPlanet] = useState(null);
  const [showScrying, setShowScrying] = useState(false);
  const [showExitButton, setShowExitButton] = useState(true);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [isLoading, setIsLoading] = useState(false);

  const dayRuler = DAY_RULERS[currentTime.getDay()];
  const dayColors = DAY_COLORS[dayRuler];

  useEffect(() => {
    calculateHours();
    const interval = setInterval(() => {
      setCurrentTime(new Date());
      calculateHours();
    }, 60000);
    return () => clearInterval(interval);
  }, [location]);

  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentTime(new Date());
      if (hours.length > 0) {
        const now = new Date();
        const current = hours.find(h => now >= h.start && now < h.end);
        setCurrentHour(current);
      }
    }, 1000);
    return () => clearInterval(interval);
  }, [hours]);

  useEffect(() => {
    if (birthData?.date && birthData?.time) {
      try {
        const birthDateTime = new Date(`${birthData.date}T${birthData.time}`);
        const longs = planetLongitudes(birthDateTime);
        const chart = Object.keys(longs).map(planet => ({
          planet,
          longitude: longs[planet],
          zodiac: getZodiacFromLongitude(longs[planet])
        }));
        setNatalChart(chart);
      } catch (error) {
        console.error('Natal chart error:', error);
      }
    }
  }, [birthData]);

  function calculateHours() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const ruler = DAY_RULERS[today.getDay()];
    
    try {
      const sunTimes = getSunTimes(today, location.lat, location.lon);
      const planetaryHours = generatePlanetaryHours(ruler, sunTimes.sunrise, sunTimes.sunset);
      
      const hoursWithNatal = planetaryHours.map(h => {
        let natalMatch = false;
        if (natalChart) {
          const natalPlanet = natalChart.find(p => p.planet === h.planet.name);
          if (natalPlanet && natalPlanet.zodiac.name === h.zodiac.name) {
            natalMatch = true;
          }
        }
        const strength = getHourStrength(h.planet.name, h.zodiac.name, natalMatch);
        return { ...h, natalMatch, strength };
      });
      
      setHours(hoursWithNatal);
      const current = hoursWithNatal.find(h => now >= h.start && now < h.end);
      setCurrentHour(current);
    } catch (error) {
      console.error('Hours calculation error:', error);
    }
  }

  async function updateLocation(input) {
    if (!input) return;
    
    const sanitized = sanitizeInput(input);
    if (!sanitized) {
      alert('Invalid location');
      return;
    }

    if (!rateLimiter.canMakeRequest('geocode')) {
      alert('Too many requests. Wait a moment.');
      return;
    }

    setIsLoading(true);
    
    const query = sanitized.includes(',') && sanitized.split(',').length >= 2 
      ? sanitized 
      : `${sanitized}, USA`;
    
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`,
        { 
          headers: { "User-Agent": "PlanetaryHoursApp/5.0" },
          signal: controller.signal
        }
      );
      
      clearTimeout(timeoutId);
      
      if (!response.ok) throw new Error('Service unavailable');
      
      const data = await response.json();
      if (data?.length > 0) {
        setLocation({
          lat: parseFloat(data[0].lat),
          lon: parseFloat(data[0].lon),
          city: data[0].display_name || sanitized
        });
      } else {
        alert('Location not found');
      }
    } catch (error) {
      alert(error.name === 'AbortError' ? 'Request timed out' : 'Connection error');
    } finally {
      setIsLoading(false);
    }
  }

  const formatTime = (date) => date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

  const getTimeRemaining = (endTime) => {
    const diff = endTime - new Date();
    if (diff < 0) return "Ended";
    const mins = Math.floor(diff / 60000);
    return `${Math.floor(mins / 60)}h ${mins % 60}m`;
  };

  return (
    <div style={{ 
      minHeight: '100vh', 
      background: `linear-gradient(135deg, ${dayColors.bg} 0%, ${dayColors.bg}dd 100%)`,
      color: '#f0e6d2',
      fontFamily: 'Georgia, serif',
      transition: 'background 1s'
    }}>
      {showScrying && (
        <ScryingScreen 
          onExit={() => setShowScrying(false)} 
          showExit={showExitButton} 
          onInteract={() => { setShowExitButton(true); setTimeout(() => setShowExitButton(false), 3000); }}
          planetColor={currentHour?.planet.color || dayColors.primary}
        />
      )}

      <div style={{
        background: `linear-gradient(180deg, ${dayColors.bg}f0 0%, ${dayColors.bg}cc 100%)`,
        backdropFilter: 'blur(10px)',
        borderBottom: `2px solid ${dayColors.primary}`,
        padding: '1.5rem 0',
        position: 'sticky',
        top: 0,
        zIndex: 100
      }}>
        <div style={{ maxWidth: 1200, margin: '0 auto', padding: '0 1rem' }}>
          <h1 style={{ 
            textAlign: 'center',
            fontSize: '2.5rem',
            color: dayColors.primary,
            textShadow: `0 0 20px ${dayColors.primary}80`,
            marginBottom: '0.5rem'
          }}>
            ⭐ PLANETARY HOURS ⭐
          </h1>
          
          <div style={{ textAlign: 'center', color: '#b8a080', marginBottom: '1rem' }}>
            {currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
          </div>

          {currentHour && (
            <div style={{
              background: `linear-gradient(135deg, ${dayColors.primary}33 0%, ${dayColors.secondary}33 100%)`,
              border: `2px solid ${dayColors.primary}`,
              borderRadius: 12,
              padding: '1rem',
              textAlign: 'center',
              marginBottom: '1rem'
            }}>
              <div style={{ fontSize: '2rem', color: currentHour.planet.color }}>
                {currentHour.planet.symbol} {currentHour.planet.name}
              </div>
              <div style={{ fontSize: '0.9rem', color: '#e0d0b0', marginTop: '0.5rem' }}>
                {formatTime(currentHour.start)} - {formatTime(currentHour.end)} • {getTimeRemaining(currentHour.end)} remaining
              </div>
            </div>
          )}

          <div style={{ textAlign: 'center', color: '#b8a080', fontSize: '0.9rem' }}>
            Day Ruler: {PLANET_DETAILS[dayRuler].symbol} {dayRuler} • {location.city}
          </div>
        </div>
      </div>

      <div style={{ maxWidth: 1200, margin: '0 auto', padding: '0 1rem' }}>
        <div style={{ display: 'flex', gap: '0.5rem', padding: '1rem 0', overflowX: 'auto', justifyContent: 'center', flexWrap: 'wrap' }}>
          {[
            { id: 'hours', label: 'Hours', icon: Clock },
            { id: 'electional', label: 'Electional', icon: Star },
            { id: 'natal', label: 'Natal', icon: Calendar },
            { id: 'correspondences', label: 'Info', icon: Book },
            { id: 'settings', label: 'Settings', icon: Settings }
          ].map(view => {
            const Icon = view.icon;
            return (
              <button
                key={view.id}
                onClick={() => setActiveView(view.id)}
                style={{
                  background: activeView === view.id 
                    ? `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`
                    : `${dayColors.bg}dd`,
                  color: activeView === view.id ? dayColors.bg : dayColors.primary,
                  border: `1px solid ${dayColors.primary}`,
                  padding: '0.75rem 1.5rem',
                  borderRadius: 8,
                  cursor: 'pointer',
                  fontSize: '0.9rem',
                  fontFamily: 'inherit',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem',
                  transition: 'all 0.3s',
                  boxShadow: activeView === view.id ? `0 0 20px ${dayColors.primary}60` : 'none'
                }}
              >
                <Icon size={16} />
                {view.label}
              </button>
            );
          })}
        </div>

        <div style={{ paddingBottom: '2rem' }}>
          {activeView === 'hours' && <HoursView hours={hours} currentHour={currentHour} dayColors={dayColors} onSelectHour={setSelectedHour} formatTime={formatTime} getTimeRemaining={getTimeRemaining} />}
          {activeView === 'electional' && <ElectionalView hours={hours} currentHour={currentHour} dayColors={dayColors} onSelectHour={setSelectedHour} formatTime={formatTime} />}
          {activeView === 'natal' && <NatalView natalChart={natalChart} birthData={birthData} dayColors={dayColors} onNavigateToSettings={() => setActiveView('settings')} />}
          {activeView === 'correspondences' && <CorrespondencesView dayColors={dayColors} expandedPlanet={expandedPlanet} onExpandPlanet={setExpandedPlanet} />}
          {activeView === 'settings' && <SettingsView location={location} birthData={birthData} dayColors={dayColors} onUpdateLocation={updateLocation} onUpdateBirthData={setBirthData} isLoading={isLoading} />}
        </div>
      </div>

      {selectedHour && (
        <HourDetailModal 
          hour={selectedHour}
          dayColors={dayColors}
          onClose={() => setSelectedHour(null)}
          onStartScrying={() => setShowScrying(true)}
          formatTime={formatTime}
        />
      )}
    </div>
  );
}

function HoursView({ hours, currentHour, dayColors, onSelectHour, formatTime, getTimeRemaining }) {
  return (
    <div>
      <h2 style={{ textAlign: 'center', color: dayColors.primary, fontSize: '1.8rem', marginBottom: '1rem' }}>
        24 Planetary Hours
      </h2>
      <div style={{ display: 'grid', gap: '1rem' }}>
        {hours.map((h, idx) => {
          const isActive = currentHour && h.start.getTime() === currentHour.start.getTime();
          return (
            <div
              key={idx}
              onClick={() => onSelectHour(h)}
              style={{
                background: isActive 
                  ? `linear-gradient(135deg, ${dayColors.primary}33 0%, ${dayColors.secondary}33 100%)`
                  : `${dayColors.bg}99`,
                border: `2px solid ${isActive ? dayColors.primary : '#3a2a5a'}`,
                borderLeftWidth: 6,
                borderLeftColor: h.planet.color,
                borderRadius: 12,
                padding: '1.25rem',
                cursor: 'pointer',
                transition: 'all 0.3s'
              }}
            >
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                  <div style={{ fontSize: '2.5rem', color: h.planet.color }}>{h.planet.symbol}</div>
                  <div>
                    <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: h.planet.color }}>{h.planet.name}</div>
                    <div style={{ color: '#b8a080', fontSize: '0.9rem' }}>{formatTime(h.start)} - {formatTime(h.end)}</div>
                  </div>
                </div>
                <div style={{ textAlign: 'right' }}>
                  <div style={{ fontSize: '2rem' }}>{h.zodiac.symbol}</div>
                  <div style={{ fontSize: '0.9rem', color: '#e0d0b0' }}>{h.zodiac.name}</div>
                </div>
              </div>
              {isActive && (
                <div style={{
                  background: dayColors.primary,
                  color: dayColors.bg,
                  padding: '0.25rem 0.75rem',
                  borderRadius: 12,
                  fontSize: '0.75rem',
                  fontWeight: 'bold',
                  display: 'inline-block',
                  marginTop: '0.5rem'
                }}>
                  ACTIVE • {getTimeRemaining(h.end)}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

function ElectionalView({ hours, currentHour, dayColors, onSelectHour, formatTime }) {
  const optimal = hours.filter(h => h.strength > 1 || h.natalMatch);
  return (
    <div>
      <h2 style={{ textAlign: 'center', color: dayColors.primary, fontSize: '1.8rem', marginBottom: '1rem' }}>
        Electional Hours ({optimal.length} optimal)
      </h2>
      <div style={{ display: 'grid', gap: '1rem' }}>
        {hours.map((h, idx) => (
          <div key={idx} onClick={() => onSelectHour(h)} style={{
            background: `${dayColors.bg}99`,
            border: `2px solid #3a2a5a`,
            borderLeftWidth: 6,
            borderLeftColor: h.planet.color,
            borderRadius: 12,
            padding: '1.25rem',
            cursor: 'pointer',
            opacity: h.strength > 1 ? 1 : 0.5
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', gap: '0.75rem' }}>
                <div style={{ fontSize: '2.5rem', color: h.planet.color }}>{h.planet.symbol}</div>
                <div>
                  <div style={{ fontSize: '1.5rem', color: h.planet.color }}>{h.planet.name}</div>
                  <div style={{ fontSize: '0.9rem', color: '#b8a080' }}>{formatTime(h.start)} - {formatTime(h.end)}</div>
                </div>
              </div>
              <div>
                <div>{h.zodiac.symbol} {h.zodiac.name}</div>
                <div style={{ fontSize: '0.8rem' }}>Strength: {h.strength}</div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function CorrespondencesView({ dayColors, expandedPlanet, onExpandPlanet }) {
  return (
    <div>
      <h2 style={{ textAlign: 'center', color: dayColors.primary, fontSize: '1.8rem', marginBottom: '1rem' }}>
        Planetary Correspondences
      </h2>
      <div style={{ display: 'grid', gap: '1rem' }}>
        {Object.entries(CORRESPONDENCES).map(([planet, data]) => (
          <div key={planet}>
            <div onClick={() => onExpandPlanet(expandedPlanet === planet ? null : planet)} style={{
              background: `${dayColors.bg}99`,
              border: `2px solid ${expandedPlanet === planet ? dayColors.primary : '#3a2a5a'}`,
              borderLeftWidth: 6,
              borderLeftColor: PLANET_DETAILS[planet].color,
              borderRadius: 12,
              padding: '1rem',
              cursor: 'pointer'
            }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                  <span style={{ fontSize: '2rem', color: PLANET_DETAILS[planet].color }}>
                    {PLANET_DETAILS[planet].symbol}
                  </span>
                  <div>
                    <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: PLANET_DETAILS[planet].color }}>
                      {planet}
                    </div>
                    <div style={{ fontSize: '0.85rem', color: '#b8a080' }}>
                      {data.metal}
                    </div>
                  </div>
                </div>
                <div style={{ fontSize: '0.9rem', color: '#b8a080' }}>
                  {data.suitable}
                </div>
              </div>
            </div>
            
            {expandedPlanet === planet && (
              <div style={{
                background: `${dayColors.primary}20`,
                border: `2px solid ${dayColors.primary}`,
                borderTop: 'none',
                borderRadius: '0 0 12px 12px',
                padding: '1.5rem',
                marginTop: '-12px'
              }}>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem' }}>
                  <div>
                    <h4 style={{ color: dayColors.primary, marginBottom: '0.5rem' }}>Sacred Names</h4>
                    <p style={{ fontSize: '0.9rem' }}><strong>Divine:</strong> {data.divineNames}</p>
                    <p style={{ fontSize: '0.9rem' }}><strong>Archangel:</strong> {data.archangel}</p>
                    <p style={{ fontSize: '0.9rem' }}><strong>Intelligence:</strong> {data.intelligence}</p>
                    <p style={{ fontSize: '0.9rem' }}><strong>Spirit:</strong> {data.spirit}</p>
                  </div>
                  <div>
                    <h4 style={{ color: dayColors.primary, marginBottom: '0.5rem' }}>Materials</h4>
                    <p style={{ fontSize: '0.9rem' }}><strong>Metal:</strong> {data.metal}</p>
                    <p style={{ fontSize: '0.9rem' }}><strong>Incense:</strong> {data.incense}</p>
                    <p style={{ fontSize: '0.9rem' }}><strong>Crystals:</strong> {data.crystals}</p>
                  </div>
                </div>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}

function SettingsView({ location, birthData, dayColors, onUpdateLocation, onUpdateBirthData, isLoading }) {
  const [locationInput, setLocationInput] = useState(location.city);
  const [birthDate, setBirthDate] = useState(birthData?.date || '');
  const [birthTime, setBirthTime] = useState(birthData?.time || '');
  const [birthLocation, setBirthLocation] = useState(birthData?.location || '');

  return (
    <div style={{ maxWidth: 600, margin: '0 auto' }}>
      <div style={{
        background: `${dayColors.bg}99`,
        border: '1px solid #3a2a5a',
        borderRadius: 12,
        padding: '1.5rem',
        marginBottom: '1.5rem'
      }}>
        <h3 style={{ color: dayColors.primary, marginBottom: '1rem' }}>Location</h3>
        <input
          type="text"
          value={locationInput}
          onChange={(e) => setLocationInput(e.target.value)}
          placeholder="City, State, Country"
          style={{
            width: '100%',
            background: `${dayColors.bg}cc`,
            border: '1px solid #3a2a5a',
            borderRadius: 8,
            padding: '0.75rem',
            color: '#f0e6d2',
            fontSize: '1rem',
            marginBottom: '1rem'
          }}
        />
        <button
          onClick={() => onUpdateLocation(locationInput)}
          disabled={isLoading}
          style={{
            width: '100%',
            background: isLoading ? '#666' : `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
            color: dayColors.bg,
            border: 'none',
            padding: '1rem',
            borderRadius: 8,
            fontSize: '1rem',
            fontWeight: 'bold',
            cursor: isLoading ? 'not-allowed' : 'pointer'
          }}
        >
          {isLoading ? 'Updating...' : 'Update Location'}
        </button>
      </div>

      <div style={{
        background: `${dayColors.bg}99`,
        border: '1px solid #3a2a5a',
        borderRadius: 12,
        padding: '1.5rem'
      }}>
        <h3 style={{ color: dayColors.primary, marginBottom: '1rem' }}>Birth Data</h3>
        <input
          type="date"
          value={birthDate}
          onChange={(e) => setBirthDate(e.target.value)}
          style={{
            width: '100%',
            background: `${dayColors.bg}cc`,
            border: '1px solid #3a2a5a',
            borderRadius: 8,
            padding: '0.75rem',
            color: '#f0e6d2',
            fontSize: '1rem',
            marginBottom: '1rem'
          }}
        />
        <input
          type="time"
          value={birthTime}
          onChange={(e) => setBirthTime(e.target.value)}
          style={{
            width: '100%',
            background: `${dayColors.bg}cc`,
            border: '1px solid #3a2a5a',
            borderRadius: 8,
            padding: '0.75rem',
            color: '#f0e6d2',
            fontSize: '1rem',
            marginBottom: '1rem'
          }}
        />
        <input
          type="text"
          value={birthLocation}
          onChange={(e) => setBirthLocation(e.target.value)}
          placeholder="Birth Location (optional)"
          style={{
            width: '100%',
            background: `${dayColors.bg}cc`,
            border: '1px solid #3a2a5a',
            borderRadius: 8,
            padding: '0.75rem',
            color: '#f0e6d2',
            fontSize: '1rem',
            marginBottom: '1rem'
          }}
        />
        <button
          onClick={() => {
            if (birthDate && birthTime) {
              onUpdateBirthData({ date: birthDate, time: birthTime, location: birthLocation });
              alert('Birth data saved!');
            } else {
              alert('Please enter date and time');
            }
          }}
          style={{
            width: '100%',
            background: `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
            color: dayColors.bg,
            border: 'none',
            padding: '1rem',
            borderRadius: 8,
            fontSize: '1rem',
            fontWeight: 'bold',
            cursor: 'pointer'
          }}
        >
          Save Birth Data
        </button>
      </div>
    </div>
  );
}

function HourDetailModal({ hour, dayColors, onClose, onStartScrying, formatTime }) {
  const corr = CORRESPONDENCES[hour.planet.name];

  return (
    <div 
      style={{ 
        position: 'fixed', 
        top: 0, 
        left: 0, 
        width: '100%', 
        height: '100%', 
        background: 'rgba(0,0,0,0.95)', 
        zIndex: 2000,
        overflowY: 'auto',
        padding: '2rem'
      }}
      onClick={onClose}
    >
      <div 
        style={{
          maxWidth: 800,
          margin: '0 auto',
          background: `linear-gradient(135deg, ${dayColors.bg}f5 0%, ${dayColors.bg}dd 100%)`,
          border: `2px solid ${dayColors.primary}`,
          borderRadius: 16,
          padding: '2rem'
        }}
        onClick={(e) => e.stopPropagation()}
      >
        <button
          onClick={onClose}
          style={{
            background: '#8b5cf6',
            color: 'white',
            border: 'none',
            padding: '0.75rem 1.5rem',
            borderRadius: 8,
            cursor: 'pointer',
            fontSize: '1rem',
            marginBottom: '1rem'
          }}
        >
          ← Back
        </button>

        <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
          <div style={{ fontSize: '6rem', color: hour.planet.color }}>{hour.planet.symbol}</div>
          <h2 style={{ fontSize: '2.5rem', color: hour.planet.color, margin: '1rem 0' }}>
            Hour of {hour.planet.name}
          </h2>
          <div style={{ fontSize: '1.2rem', color: '#e0d0b0' }}>
            {formatTime(hour.start)} - {formatTime(hour.end)}
          </div>
          <div style={{ fontSize: '1.5rem', marginTop: '1rem' }}>
            {hour.zodiac.symbol} {hour.zodiac.name}
          </div>
        </div>

        <div style={{ background: 'rgba(0,0,0,0.4)', padding: '1.5rem', borderRadius: 12, marginBottom: '1.5rem' }}>
          <h3 style={{ color: dayColors.primary, marginBottom: '1rem' }}>Correspondences</h3>
          <p><strong>Suitable For:</strong> {corr.suitable}</p>
          <p><strong>Archangel:</strong> {corr.archangel}</p>
          <p><strong>Metal:</strong> {corr.metal}</p>
          <p><strong>Incense:</strong> {corr.incense}</p>
          <p><strong>Crystals:</strong> {corr.crystals}</p>
        </div>

        <div style={{ textAlign: 'center' }}>
          <button
            onClick={(e) => {
              e.stopPropagation();
              onStartScrying();
            }}
            style={{
              background: `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
              color: dayColors.bg,
              border: 'none',
              padding: '1rem 2rem',
              borderRadius: 8,
              fontSize: '1rem',
              fontWeight: 'bold',
              cursor: 'pointer',
              display: 'inline-flex',
              alignItems: 'center',
              gap: '0.5rem'
            }}
          >
            <Eye size={20} />
            Begin Scrying
          </button>
        </div>
      </div>
    </div>
  );
}

function ScryingScreen({ onExit, showExit, onInteract, planetColor }) {
  const canvasRef = useRef(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let animationId;
    let noiseData = new Uint8Array(canvas.width * canvas.height);

    function generateNoise() {
      for (let i = 0; i < noiseData.length; i++) {
        noiseData[i] = Math.random() * 255;
      }
    }

    function drawStatic() {
      generateNoise();
      const imageData = ctx.createImageData(canvas.width, canvas.height);
      const data = imageData.data;

      for (let i = 0; i < noiseData.length; i++) {
        const value = noiseData[i];
        const idx = i * 4;
        data[idx] = value;
        data[idx + 1] = value;
        data[idx + 2] = value;
        data[idx + 3] = 255;
      }

      ctx.putImageData(imageData, 0, 0);
      
      // Add scanlines
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      for (let y = 0; y < canvas.height; y += 4) {
        ctx.fillRect(0, y, canvas.width, 2);
      }
      
      // Add flicker
      if (Math.random() > 0.95) {
        ctx.fillStyle = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.05)`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      animationId = requestAnimationFrame(drawStatic);
    }

    drawStatic();

    return () => {
      if (animationId) cancelAnimationFrame(animationId);
    };
  }, []);

  return (
    <div
      style={{
        position: 'fixed',
        top: 0,
        left: 0,
        width: '100%',
        height: '100%',
        background: '#000',
        zIndex: 3000,
        cursor: 'pointer'
      }}
      onClick={onInteract}
    >
      <canvas
        ref={canvasRef}
        style={{
          width: '100%',
          height: '100%',
          display: 'block'
        }}
      />
      {showExit && (
        <button
          onClick={(e) => {
            e.stopPropagation();
            onExit();
          }}
          style={{
            position: 'absolute',
            top: 20,
            right: 20,
            background: '#dc2626',
            color: 'white',
            border: 'none',
            padding: '1rem 2rem',
            borderRadius: 8,
            fontSize: '1rem',
            fontWeight: 'bold',
            cursor: 'pointer',
            zIndex: 3001
          }}
        >
          Exit Scrying
        </button>
      )}
    </div>
  );
}

function NatalView({ natalChart, birthData, dayColors, onNavigateToSettings }) {
  if (!natalChart) {
    return (
      <div style={{ textAlign: 'center', padding: '3rem' }}>
        <p style={{ fontSize: '1.2rem', marginBottom: '1rem' }}>No birth data set</p>
        <button onClick={onNavigateToSettings} style={{
          background: `linear-gradient(135deg, ${dayColors.primary} 0%, ${dayColors.secondary} 100%)`,
          color: dayColors.bg,
          border: 'none',
          padding: '1rem 2rem',
          borderRadius: 8,
          cursor: 'pointer',
          fontSize: '1rem'
        }}>
          Add Birth Data
        </button>
      </div>
    );
  }

  return (
    <div>
      <h2 style={{ textAlign: 'center', color: dayColors.primary, fontSize: '1.8rem', marginBottom: '1rem' }}>Natal Chart</h2>
      <div style={{ display: 'grid', gap: '1rem' }}>
        {natalChart.map((item, idx) => (
          <div key={idx} style={{
            background: `${dayColors.bg}99`,
            border: `2px solid #3a2a5a`,
            borderLeftWidth: 6,
            borderLeftColor: PLANET_DETAILS[item.planet].color,
            borderRadius: 12,
            padding: '1.25rem'
          }}>
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                <div style={{ fontSize: '2.5rem', color: PLANET_DETAILS[item.planet].color }}>
                  {PLANET_DETAILS[item.planet].symbol}
                </div>
                <div>
                  <div style={{ fontSize: '1.5rem', color: PLANET_DETAILS[item.planet].color }}>{item.planet}</div>
                  <div style={{ fontSize: '0.9rem', color: '#b8a080' }}>{item.longitude.toFixed(2)}°</div>
                </div>
              </div>
              <div style={{ textAlign: 'right' }}>
                <div style={{ fontSize: '2.5rem' }}>{item.zodiac.symbol}</div>
                <div style={{ fontSize: '1.2rem', color: '#e0d0b0' }}>{item.zodiac.name}</div>
              </div>
            </div>
          </div>
